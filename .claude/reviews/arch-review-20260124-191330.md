# Architectural Review: Epic 5A (dbt Plugin Abstraction)

**Branch**: `5a-dbt-plugin`
**Base**: `main`
**Date**: 2026-01-24
**Reviewer**: Claude Code (Arch Review Skill)

---

## Executive Summary

Epic 5A introduces the **DBTPlugin** abstraction layer with two implementations (DBTCorePlugin and DBTFusionPlugin). The implementation demonstrates **strong alignment** with floe's target architecture and follows established patterns correctly.

### Alignment Score: **92/100** (EXCELLENT)

| Category | Score | Notes |
|----------|-------|-------|
| Four-Layer Architecture | 95 | Correct Layer 1 placement, no upward dependencies |
| Technology Ownership | 98 | "dbt owns SQL" principle strictly followed |
| Contract Compliance | 90 | DBTPlugin ABC well-defined, LintResult has minor duplication |
| Security | 95 | subprocess uses list form, no shell=True |
| Testing Standards | 85 | pytest.skip() in integration conftest.py |

---

## Findings by Severity

### CRITICAL (0)

No critical architectural violations found.

### HIGH (0)

No high-severity issues found.

### MEDIUM (2)

#### M-001: pytest.skip() in Integration Test Conftest

**Location**: `plugins/floe-dbt-core/tests/integration/conftest.py:38-40`
**Location**: `plugins/floe-dbt-fusion/tests/integration/conftest.py` (similar)

**Issue**: Uses `pytest.skip()` for missing dependencies:
```python
if not DBT_AVAILABLE:
    pytest.skip("dbt-core not installed - skipping integration test")
```

**Standards Reference**: `.claude/rules/testing-standards.md` - "Tests FAIL, Never Skip"

**Impact**:
- Tests may silently skip in CI if dependency not installed
- Hides potential configuration issues

**Recommendation**:
Replace with `pytest.fail()`:
```python
if not DBT_AVAILABLE:
    pytest.fail(
        "dbt-core not installed - install with: pip install dbt-core\n"
        "Run: make test-integration"
    )
```

**Severity**: MEDIUM (hidden test failures in CI)

---

#### M-002: LintResult Type Inconsistency Between Packages

**Location**:
- `packages/floe-core/src/floe_core/plugins/dbt.py:71-92` (LintResult)
- `plugins/floe-dbt-core/src/floe_dbt_core/linting.py` (LintResult reimplemented)

**Issue**: Two LintResult classes exist with slightly different structures:
- floe-core: `LintResult` with `issues: list[dict[str, Any]]`
- floe-dbt-core: `LintResult` with `violations: list[LintViolation]`

The core LintResult uses `issues` property, while the plugin implementation uses `violations`.

**Standards Reference**: `.claude/rules/pydantic-contracts.md` - Use CompiledArtifacts as the SOLE contract

**Impact**:
- Consumers may be confused which LintResult to use
- Documentation inconsistency (quickstart.md uses `violations`)

**Recommendation**:
1. Use floe-core's `LintResult` in plugins (import, don't redefine)
2. Or export plugin's `LintResult` through floe-core to maintain single source

**Severity**: MEDIUM (API clarity issue)

---

### LOW (2)

#### L-001: TYPE_CHECKING Import Not Used

**Location**: `plugins/floe-dbt-fusion/src/floe_dbt_fusion/plugin.py:52-53`

```python
if TYPE_CHECKING:
    pass
```

**Issue**: Empty TYPE_CHECKING block (SonarQube S108: empty code blocks)

**Recommendation**: Remove the empty block or add intended imports.

---

#### L-002: Inconsistent floe_api_version Format

**Location**:
- DBTCorePlugin: `floe_api_version = "1.0"`
- DBTFusionPlugin: `floe_api_version = "1.0.0"`

**Issue**: Different version string formats.

**Recommendation**: Standardize to semver format (`"1.0.0"`).

---

## Positive Findings (EXCELLENT)

### P-001: Technology Ownership Compliance

**Pattern**: "dbt owns SQL" principle strictly followed

**Evidence**:
- Orchestrator (floe-orchestrator-dagster) does NOT import `dbt.cli`
- Pre-commit hook `scripts/pre-commit-no-dbt-runner.sh` enforces this
- All SQL operations delegated through DBTPlugin ABC

**Standards Reference**: `.claude/rules/component-ownership.md`

---

### P-002: Correct Plugin Architecture Pattern

**Pattern**: Entry points + ABC + Registry pattern

**Evidence**:
```toml
# plugins/floe-dbt-core/pyproject.toml
[project.entry-points."floe.dbt"]
core = "floe_dbt_core:DBTCorePlugin"

# plugins/floe-dbt-fusion/pyproject.toml
[project.entry-points."floe.dbt"]
fusion = "floe_dbt_fusion:DBTFusionPlugin"
```

This matches the documented plugin system in `docs/architecture/plugin-system/index.md`.

---

### P-003: Secure subprocess Usage

**Pattern**: subprocess.run() with list arguments (not shell=True)

**Evidence** (`plugins/floe-dbt-fusion/src/floe_dbt_fusion/plugin.py:192-197`):
```python
result = subprocess.run(
    cmd,  # List of arguments
    capture_output=True,
    text=True,
    check=False,  # Handle errors explicitly
)
```

**Standards Reference**: `.claude/rules/security.md` - Command injection prevention

---

### P-004: Contract Tests for Plugin ABC

**Location**: `tests/contract/test_dbt_plugin_contract.py`

**Evidence**: Comprehensive contract tests including:
- ABC instantiation prevention (T061)
- Method signature validation
- Plugin compliance tests for both implementations (T062-T063)

This aligns with contract-driven integration pattern.

---

### P-005: Thread-Safety Documentation

**Pattern**: Clear capability differentiation via `supports_parallel_execution()`

**Evidence**:
- DBTCorePlugin returns `False` (dbtRunner is NOT thread-safe)
- DBTFusionPlugin returns `True` (Rust-based, thread-safe)
- Well-documented in docstrings and tests

---

### P-006: Fallback Mechanism with Graceful Degradation

**Pattern**: Automatic fallback from Fusion to Core when adapter unavailable

**Evidence** (`plugins/floe-dbt-fusion/src/floe_dbt_fusion/fallback.py`):
- Detects Fusion binary availability
- Checks Rust adapter support
- Falls back to dbt-core with logging
- Raises clear error if neither available

---

### P-007: Dagster Resource Proper Delegation

**Pattern**: Orchestrator uses DBTPlugin abstraction, not direct dbtRunner

**Evidence** (`plugins/floe-orchestrator-dagster/src/floe_orchestrator_dagster/resources/dbt_resource.py`):
```python
from floe_core.plugins.dbt import DBTPlugin, DBTRunResult, LintResult
# ...
plugin = load_dbt_plugin(self.plugin_name)  # Via registry
```

This maintains layer separation (SC-004).

---

### P-008: OpenTelemetry Integration

**Pattern**: Structured tracing for dbt operations

**Evidence** (`plugins/floe-dbt-core/src/floe_dbt_core/tracing.py`):
- Tracer initialization
- Span context for compile/run/test/lint operations
- Runtime attributes on spans

**Standards Reference**: Enforced OTel standard per `docs/architecture/opinionation-boundaries.md`

---

### P-009: dbt Version Requirements Enforcement

**Pattern**: CI validation of dbt version bounds

**Evidence** (`.github/workflows/ci.yml:89-117`):
- Validates `dbt-core>=1.6,<2.0` in floe-dbt-core
- Validates MIN_FUSION_VERSION constant in floe-dbt-fusion
- Fails build if requirements not met

---

## Persona Impact Analysis

### Data Engineers (Primary)

| Aspect | Impact | Score |
|--------|--------|-------|
| Cognitive Load | LOW - Single DBTPlugin interface | 9/10 |
| Developer Experience | HIGH - Consistent API across runtimes | 9/10 |
| Error Messages | GOOD - Structured errors with locations | 8/10 |
| Documentation | GOOD - Comprehensive quickstart.md | 8/10 |

### Platform Engineers

| Aspect | Impact | Score |
|--------|--------|-------|
| Plugin Selection | EXCELLENT - Manifest-driven selection | 9/10 |
| Governance | GOOD - Pre-commit hook enforcement | 9/10 |
| Observability | EXCELLENT - OTel integration | 9/10 |
| Versioning | GOOD - Entry points + semver | 8/10 |

### DevOps/SRE

| Aspect | Impact | Score |
|--------|--------|-------|
| K8s-native | N/A - Not applicable to this epic | - |
| Fallback | EXCELLENT - Graceful degradation | 9/10 |
| Binary Detection | GOOD - Standard path checking | 8/10 |

### Security Engineers

| Aspect | Impact | Score |
|--------|--------|-------|
| Subprocess Safety | EXCELLENT - No shell=True | 10/10 |
| Secret Handling | N/A - No credentials in plugins | - |
| Input Validation | GOOD - Pydantic models | 8/10 |

---

## Recommendations (Prioritized)

### Priority 1: Fix pytest.skip() Usage (M-001)

**Effort**: Low (10 minutes)
**Impact**: Prevents hidden test failures

Replace `pytest.skip()` with `pytest.fail()` in:
- `plugins/floe-dbt-core/tests/integration/conftest.py`
- `plugins/floe-dbt-fusion/tests/integration/conftest.py`

### Priority 2: Consolidate LintResult Type (M-002)

**Effort**: Medium (1-2 hours)
**Impact**: API clarity

Either:
1. Import `LintResult` from `floe_core.plugins.dbt` in plugins
2. Or extend the core `LintResult` to include `violations` property

### Priority 3: Clean Up Empty TYPE_CHECKING (L-001)

**Effort**: Low (5 minutes)
**Impact**: Code cleanliness

Remove empty `if TYPE_CHECKING: pass` block in `plugin.py`.

### Priority 4: Standardize floe_api_version (L-002)

**Effort**: Low (5 minutes)
**Impact**: Consistency

Use `"1.0.0"` in both plugins.

---

## Documentation Review

### Spec Alignment

The implementation aligns well with `specs/5a-dbt-plugin/spec.md`:
- FR-001 through FR-019 implemented
- SC-001 through SC-004 verified
- NFR-003 (dbt-core>=1.6) validated in CI
- NFR-004 (Fusion>=1.0) validated in CI

### Architecture Docs Updated

No architecture doc updates required. The plugin follows existing patterns in:
- `docs/architecture/plugin-system/index.md`
- `docs/architecture/opinionation-boundaries.md`

---

## Change Statistics

| Category | Files | Lines Added | Lines Removed |
|----------|-------|-------------|---------------|
| Python (src) | 18 | ~5,500 | 0 |
| Python (tests) | 15 | ~4,500 | 0 |
| Config (YAML/TOML) | 4 | ~250 | 0 |
| Documentation | 3 | ~200 | 0 |
| CI/Pre-commit | 3 | ~75 | 0 |
| **Total** | **43** | **~10,500** | **0** |

---

## Conclusion

Epic 5A demonstrates **excellent architectural alignment** with floe's target state. The implementation:

1. **Correctly applies** the plugin pattern (ABC + entry points + registry)
2. **Enforces** technology ownership ("dbt owns SQL")
3. **Provides** comprehensive contract tests
4. **Includes** observability (OTel) integration
5. **Maintains** security best practices (subprocess list form)

The two MEDIUM findings (pytest.skip and LintResult duplication) are straightforward to address and do not block approval.

**Recommendation**: APPROVE with minor fixes

---

## Memory Save Command

```bash
./scripts/memory-save --decisions "Epic 5A arch review: APPROVE 92/100. DBTPlugin ABC correct. pytest.skip needs fix. LintResult duplication minor." --issues "FLO-1609"
```
