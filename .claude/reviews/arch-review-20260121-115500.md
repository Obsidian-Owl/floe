# Architectural Review: Epic 11 CLI Unification

**Date**: 2026-01-21
**Branch**: `11-cli-unification`
**Reviewer**: Claude Code (Arch Review Skill)
**Epic**: CLI Unification (11)

---

## Executive Summary

**Overall Score**: 55/100 (NEEDS REMEDIATION)

The CLI Unification epic achieved its primary goal of creating a unified Click-based CLI in floe-core. However, **critical cleanup was not performed**, leaving significant tech debt:

| Issue | Severity | Impact |
|-------|----------|--------|
| floe-cli source code NOT removed | CRITICAL | 2,000 LOC dead code |
| floe-cli tests NOT removed | CRITICAL | 2,700 LOC orphaned tests |
| Old argparse files NOT removed | HIGH | 1,500 LOC duplicate code |
| RBAC audit logic NOT migrated | HIGH | Security features lost |
| ADR structure deviation | MEDIUM | data/ directory empty |

---

## Findings by Severity

### CRITICAL (Must Fix Before Merge)

#### C-001: Dead Code - floe-cli Source Not Removed

**Location**: `packages/floe-cli/src/floe_cli/`

**Description**: The entire floe-cli source code (~2,000 lines) remains in the repository after CLI unification. Per ADR-0047 Phase 3, floe-cli should be deprecated and source removed.

**Files**:
- `packages/floe-cli/src/floe_cli/__init__.py` (15 lines)
- `packages/floe-cli/src/floe_cli/main.py` (884 lines)
- `packages/floe-cli/src/floe_cli/commands/__init__.py` (7 lines)
- `packages/floe-cli/src/floe_cli/commands/rbac.py` (1,065 lines)

**Impact**:
- Maintenance burden (developers may edit wrong files)
- Confusion about canonical location
- CI runs dead tests
- Package still importable, causing namespace conflicts

**Recommendation**:
```bash
rm -rf packages/floe-cli/src/
# Keep only pyproject.toml (with commented entry point) and README.md
```

---

#### C-002: Orphaned Tests - floe-cli Tests Not Removed

**Location**: `packages/floe-cli/tests/`

**Description**: 95 tests (~2,700 lines) remain in floe-cli but test deprecated code. These tests still run in CI, wasting resources and causing confusion.

**Files**:
- `packages/floe-cli/tests/conftest.py` (13 lines)
- `packages/floe-cli/tests/integration/` (523 lines)
- `packages/floe-cli/tests/unit/` (2,122 lines)

**Impact**:
- CI runs ~100 unnecessary tests
- Tests validate dead code
- 1 test already failing (test_validate_json_output)

**Recommendation**:
```bash
rm -rf packages/floe-cli/tests/
```

---

#### C-003: RBAC Audit/Validation Logic NOT Migrated

**Location**: `packages/floe-cli/src/floe_cli/commands/rbac.py` vs `packages/floe-core/src/floe_core/cli/rbac/`

**Description**: The new RBAC CLI commands are shallow wrappers that lost ~80% of the original functionality:

| Feature | Old (floe-cli) | New (floe-core) |
|---------|----------------|-----------------|
| Wildcard detection (3 types) | `detect_wildcard_permissions()` | NOT MIGRATED |
| Secret constraint checks | `check_missing_resource_names()` | NOT MIGRATED |
| Validation result models | `RBACValidationResult` | Dict only |
| Audit report models | `RBACAuditReport` | Dict only |
| Deep resource diff | `compute_rbac_diff()` | Name-only comparison |
| Multiple namespace support | Yes | Single namespace required |

**Impact**:
- Security audit capabilities lost
- Breaking API changes (--namespace now required)
- Cannot detect overly-permissive RBAC configurations
- Tests for these features orphaned

**Recommendation**:
1. Migrate `detect_wildcard_permissions()` to `floe_core.rbac.audit`
2. Migrate `check_missing_resource_names()` to `floe_core.rbac.audit`
3. Migrate Pydantic models to `floe_core.schemas.rbac`
4. Update CLI commands to use migrated functions
5. Restore multiple namespace support

---

### HIGH

#### H-001: Old Argparse CLI Files Not Removed

**Location**: `packages/floe-core/src/floe_core/cli/`

**Description**: Old argparse implementations coexist with new Click implementations:

| Old (argparse) | New (Click) | Lines |
|----------------|-------------|-------|
| `artifact.py` | `artifact/push.py` | 1,220 |
| `compile.py` | `platform/compile.py` | 317 |

**Impact**:
- 1,537 lines of duplicate code
- `import argparse` in a Click-only codebase
- Confusion about which implementation is canonical
- Dead imports and entry points

**Recommendation**:
```bash
rm packages/floe-core/src/floe_core/cli/artifact.py
rm packages/floe-core/src/floe_core/cli/compile.py
```

---

#### H-002: Empty data/ Directory

**Location**: `packages/floe-core/src/floe_core/cli/data/`

**Description**: Per ADR-0047, the `data/` directory should contain Data Team CLI commands. Instead:
- `data/__init__.py` exists (empty, 26 lines docstring)
- Actual stubs are in `data_team.py` at CLI root

**ADR-0047 Target**:
```
└── data/
    ├── __init__.py
    ├── compile.py
    ├── validate.py
    ├── run.py
    └── test.py
```

**Actual**:
```
├── data/
│   └── __init__.py (empty)
└── data_team.py (all stubs)
```

**Impact**:
- Deviation from documented architecture
- Future maintainers confused by empty directory
- data_team.py is a flat file, not a proper package

**Recommendation**:
Either:
1. Move stubs from `data_team.py` to `data/*.py` per ADR
2. OR remove empty `data/` directory and update ADR

---

### MEDIUM

#### M-001: Requirement Traceability Gaps

**Description**: New CLI tests have requirement markers but don't trace back to original spec requirements consistently.

**Example**:
```python
# tests/unit/cli/test_rbac_audit.py
@pytest.mark.requirement("FR-024")  # Correct
def test_audit_accepts_namespace_option():
    ...
```

But some tests lack markers or have inconsistent naming.

**Recommendation**: Run traceability check and fix gaps:
```bash
uv run python -m testing.traceability --all --threshold 100
```

---

#### M-002: Missing Integration with Plugin System

**Description**: The RBAC CLI commands attempt to use `RBACPlugin` but fall back to inline implementations when the plugin is not available. This creates two code paths that may diverge.

**Location**: `packages/floe-core/src/floe_core/cli/rbac/generate.py:104`

**Recommendation**: Document the fallback behavior and ensure tests cover both paths.

---

## Cleanup Checklist

### Must Complete Before Merge

- [ ] **C-001**: Remove `packages/floe-cli/src/` directory
- [ ] **C-002**: Remove `packages/floe-cli/tests/` directory
- [ ] **C-003**: Migrate RBAC audit/validation logic OR create followup issue
- [ ] **H-001**: Remove `packages/floe-core/src/floe_core/cli/artifact.py`
- [ ] **H-001**: Remove `packages/floe-core/src/floe_core/cli/compile.py`
- [ ] **H-002**: Resolve data/ directory structure

### Should Complete (Can Be Followup Issue)

- [ ] **M-001**: Verify all new CLI tests have requirement markers
- [ ] **M-002**: Document plugin fallback behavior

---

## Positive Findings

1. **ADR Documentation**: ADR-0047 clearly documents the CLI architecture decision
2. **Click Migration**: Core CLI structure follows Click best practices
3. **Entry Point Unification**: Single `floe` entry point in floe-core
4. **Deprecation Notice**: floe-cli README has clear migration instructions
5. **Test Coverage**: 65 new CLI tests for core functionality
6. **Help Text**: Comprehensive help with examples for all commands

---

## Persona Impact Analysis

### Data Engineers (Primary Persona)
| Aspect | Score | Notes |
|--------|-------|-------|
| Cognitive Load | 7/10 | Clear command groups |
| DX | 6/10 | Stubs provide guidance |
| Clarity | 8/10 | Good help text |
| Workflow | 5/10 | RBAC features degraded |

### Platform Engineers
| Aspect | Score | Notes |
|--------|-------|-------|
| Consistency | 4/10 | Dead code confusing |
| Governance | 5/10 | Audit features lost |
| Immutability | 8/10 | Click structure good |
| Multi-env | 7/10 | Registry auth works |

### Security Engineers
| Aspect | Score | Notes |
|--------|-------|-------|
| Credentials | 8/10 | Env var auth correct |
| Secrets | 8/10 | No hardcoded secrets |
| Audit | 3/10 | Audit features lost |
| Validation | 4/10 | Validation logic lost |

---

## Change Statistics

| Metric | Value |
|--------|-------|
| Files changed | 97 |
| Lines added (approx) | 8,000+ |
| Lines removed (approx) | 200 |
| New tests | 204 collected |
| Dead code remaining | 4,237 lines |
| Duplicate code | 1,537 lines |

---

## Recommendations (Prioritized)

### P1: Critical Cleanup (Block Merge)
1. Remove `packages/floe-cli/src/` - dead code
2. Remove `packages/floe-cli/tests/` - orphaned tests
3. Remove `packages/floe-core/src/floe_core/cli/artifact.py` - old argparse
4. Remove `packages/floe-core/src/floe_core/cli/compile.py` - old argparse

### P2: Restore Functionality (Followup Issue)
5. Create Linear issue for RBAC logic migration (track as tech debt)
6. Migrate wildcard detection to floe-core
7. Migrate audit models to floe_core.schemas.rbac

### P3: Documentation (Followup Issue)
8. Update ADR-0047 to reflect actual data/ structure
9. Add migration guide for RBAC API changes

---

## Conclusion

The Epic 11 CLI Unification made significant progress but **left critical cleanup undone**. The branch should NOT be merged until:

1. Dead code in floe-cli is removed
2. Old argparse files in floe-core are removed
3. A followup issue is created for RBAC functionality migration

**Estimated Cleanup Effort**: 2 hours

---

## References

- ADR-0047: CLI Architecture
- Spec: specs/11-cli-unification/spec.md
- CLAUDE.md: Technology ownership
