# Architectural Review: Epic 7B - K8s RBAC Plugin System

**Branch:** `7b-k8s-rbac`
**Date:** 2026-01-19
**Reviewer:** Claude Code (Architecture Review Skill)

---

## Executive Summary

Epic 7B implements a comprehensive K8s RBAC Plugin System following the floe plugin architecture patterns. The implementation demonstrates strong architectural alignment with the target state, with proper layer boundaries, Pydantic v2 syntax, and safe YAML handling. One medium-severity finding identified.

**Architectural Alignment Score: 92/100**

| Category | Score | Status |
|----------|-------|--------|
| Four-Layer Architecture | 95/100 | PASS |
| Plugin Architecture | 88/100 | PASS (1 finding) |
| Technology Ownership | 95/100 | PASS |
| Contract Compliance | 95/100 | PASS |
| Security | 98/100 | PASS |
| Testing Standards | 90/100 | PASS |

---

## Findings by Severity

### CRITICAL: None

### HIGH: None

### MEDIUM

#### MED-001: K8sRBACPlugin Does Not Inherit from RBACPlugin ABC

**Location:** `plugins/floe-rbac-k8s/src/floe_rbac_k8s/plugin.py:29`

**Issue:** The `K8sRBACPlugin` class does not inherit from the `RBACPlugin` ABC defined in `floe_core.plugins.rbac`. While it implements the same methods (duck typing), this violates the plugin architecture pattern where all plugins MUST inherit from their corresponding ABC.

**Current:**
```python
class K8sRBACPlugin:
    """Kubernetes RBAC plugin..."""
```

**Expected:**
```python
from floe_core.plugins.rbac import RBACPlugin

class K8sRBACPlugin(RBACPlugin):
    """Kubernetes RBAC plugin..."""
```

**Impact:**
- Plugin type checking via `isinstance(plugin, RBACPlugin)` will fail
- Contract compliance tests may not validate correctly
- Inconsistent with other plugin implementations (ComputePlugin, CatalogPlugin)

**Recommendation:** Add explicit inheritance from `RBACPlugin` ABC.

**Persona Impact:**
- Platform Engineers: Medium - May cause confusion in plugin validation
- Data Engineers: Low - Transparent to consumers
- DevOps/SREs: Low - No operational impact
- Security Engineers: Low - No security impact

---

### LOW: None

### INFO

#### INFO-001: New Plugin Entry Point Group

**Location:** `plugins/floe-rbac-k8s/pyproject.toml:41-42`

**Observation:** A new entry point group `floe.rbac` is introduced:
```toml
[project.entry-points."floe.rbac"]
k8s = "floe_rbac_k8s:K8sRBACPlugin"
```

**Status:** Aligned with plugin architecture patterns. This follows the established convention for other plugin types (`floe.compute`, `floe.catalog`, etc.).

#### INFO-002: RBAC Module in floe-core

**Location:** `packages/floe-core/src/floe_core/rbac/`

**Observation:** New `rbac` module added to floe-core with:
- `generator.py` - RBACManifestGenerator
- `audit.py` - Audit logging
- `result.py` - GenerationResult dataclass

**Status:** Properly placed in floe-core as it contains the orchestration logic that delegates to RBACPlugin implementations. This follows the same pattern as other floe-core components.

#### INFO-003: OpenTelemetry Integration

**Location:** `packages/floe-core/src/floe_core/rbac/generator.py:25-28`

**Observation:** Proper OpenTelemetry tracing integration:
```python
from opentelemetry import trace
tracer = trace.get_tracer(__name__)
```

**Status:** Aligned with ENFORCED OpenTelemetry standard. Spans properly cover generate, validate, and write operations.

---

## Architectural Alignment Analysis

### Four-Layer Architecture (95/100)

**PASS**: The implementation correctly places components in appropriate layers:

| Component | Layer | Placement | Status |
|-----------|-------|-----------|--------|
| RBACPlugin ABC | Layer 1 (Foundation) | `floe_core.plugins.rbac` | CORRECT |
| RBAC Schemas | Layer 1 (Foundation) | `floe_core.schemas.rbac` | CORRECT |
| K8sRBACPlugin | Layer 1 (Foundation) | `plugins/floe-rbac-k8s` | CORRECT |
| CLI Commands | Layer 1 (Foundation) | `floe-cli` | CORRECT |
| SecurityConfig | Layer 2 (Configuration) | `manifest.yaml` | CORRECT |
| Generated Manifests | Layer 4 (Data) | `target/rbac/` | CORRECT |

**Configuration Flow:** Correctly flows DOWNWARD from manifest.yaml -> RBACManifestGenerator -> YAML files.

### Plugin Architecture (88/100)

**PASS with finding**: Follows plugin patterns but missing ABC inheritance.

**Positive Findings:**
- Entry point correctly registered
- Implements all required methods from RBACPlugin ABC
- Proper delegation to schema `to_k8s_manifest()` methods
- PluginMetadata properties (name, version, floe_api_version) present

**Issue:**
- Does not inherit from RBACPlugin ABC (MED-001)

### Technology Ownership (95/100)

**PASS**: Proper technology ownership maintained:

| Domain | Owner | Status |
|--------|-------|--------|
| SQL | dbt | N/A - No SQL in RBAC |
| YAML Generation | RBAC Plugin | CORRECT |
| K8s API Interaction | kubernetes client | CORRECT |
| Validation | Pydantic | CORRECT |

**No violations detected.**

### Contract Compliance (95/100)

**PASS**: Strong contract patterns used:

1. **Pydantic v2 Syntax**: Correct usage throughout
   - `model_config = ConfigDict(frozen=True, extra="forbid")`
   - `@field_validator` with `@classmethod`
   - `@model_validator(mode="after")` with `Self` return
   - Modern generics: `list[str]`, `dict[str, Any]`

2. **Schema Immutability**: All schemas frozen (`frozen=True`)

3. **Cross-Package Contracts**:
   - SecurityConfig properly exported from floe_core
   - RBACPlugin ABC defines clear contract
   - Contract tests in `tests/contract/` directory

### Security (98/100)

**PASS**: Strong security posture:

1. **Safe YAML Handling**:
   - All loading uses `yaml.safe_load()` or `yaml.safe_load_all()`
   - No unsafe YAML loading detected

2. **No Command Injection**:
   - No subprocess calls in RBAC code
   - No shell=True usage

3. **Wildcard Prevention (FR-070)**:
   ```python
   @field_validator("api_groups", "resources", "verbs")
   @classmethod
   def no_wildcards(cls, v: list[str]) -> list[str]:
       if "*" in v:
           raise ValueError("Wildcard permissions (*) are forbidden per FR-070")
   ```

4. **Least-Privilege Defaults**:
   - `automount_token: bool = Field(default=False)`
   - `read_only_root_filesystem: bool = Field(default=True)`
   - `run_as_non_root: bool = Field(default=True)`
   - `allow_privilege_escalation: bool = Field(default=False)`

5. **No Dangerous Constructs**:
   - No eval/exec usage
   - No unsafe deserialization

### Testing Standards (90/100)

**PASS**: Good test coverage with proper organization:

| Test Type | Location | Count | Status |
|-----------|----------|-------|--------|
| Unit | `packages/floe-core/tests/unit/` | 17 files | CORRECT |
| Integration | `plugins/floe-rbac-k8s/tests/integration/` | 4 files | CORRECT |
| Contract | `tests/contract/` | 5 new files | CORRECT |
| CLI Integration | `packages/floe-cli/tests/integration/` | 1 file | CORRECT |

**Contract Tests Added:**
- `test_service_account_generation.py`
- `test_namespace_generation.py`
- `test_cross_namespace_binding.py`
- `test_rbac_manifest_generator.py`
- `test_rbac_full_pipeline.py`

**Observation:** Tests properly use `@pytest.mark.requirement()` markers for traceability.

---

## Persona Impact Analysis

### Data Engineers
| Aspect | Impact | Score |
|--------|--------|-------|
| Cognitive Load | Low - Security abstracted away | 9/10 |
| DX | Good - Clear API, comprehensive tests | 8/10 |
| Clarity | High - Well-documented schemas | 9/10 |
| Workflow | Seamless - CLI commands intuitive | 9/10 |

### Platform Engineers
| Aspect | Impact | Score |
|--------|--------|-------|
| Consistency | High - Follows plugin patterns | 9/10 |
| Governance | Strong - Wildcard prevention, PSS | 9/10 |
| Immutability | Enforced - Frozen Pydantic models | 10/10 |
| Multi-env | Supported - Configurable | 9/10 |

### DevOps Engineers / SREs
| Aspect | Impact | Score |
|--------|--------|-------|
| K8s-native | Excellent - Native RBAC/PSS | 10/10 |
| Observability | Good - OTel tracing | 9/10 |
| Declarative | Yes - YAML manifests | 10/10 |
| Reliability | High - Validation before write | 9/10 |

### Security Engineers
| Aspect | Impact | Score |
|--------|--------|-------|
| Credentials | Safe - No hardcoded secrets | 10/10 |
| Secrets | Proper - Reference-based access | 10/10 |
| Injection | Safe - No dangerous constructs | 10/10 |
| Validation | Strong - Pydantic + manual checks | 10/10 |

---

## Recommendations

### Immediate (Before PR)

1. **Fix MED-001**: Add `RBACPlugin` inheritance to `K8sRBACPlugin`:
   ```python
   from floe_core.plugins.rbac import RBACPlugin

   class K8sRBACPlugin(RBACPlugin):
       ...
   ```

### Future Enhancements (Post-Epic)

1. **Plugin Registry Integration**: Register RBAC plugins via PluginRegistry for dynamic discovery
2. **ClusterRole Support**: Extend for cluster-scoped RBAC (currently namespace-scoped only)
3. **Dry-Run Validation**: Add `kubectl apply --dry-run=client` integration

---

## Change Statistics

| Metric | Count |
|--------|-------|
| Files Modified | 70 |
| Lines Added | ~15,000 |
| New Packages | 1 (floe-rbac-k8s) |
| New Modules | 4 (rbac/, schemas/rbac.py, plugins/rbac.py, cli/commands/rbac.py) |
| Contract Tests | 5 new files |
| Unit Tests | 17 new files |

---

## Positive Findings

1. **Comprehensive Test Coverage**: Strong unit and integration test coverage with requirement traceability
2. **Security-First Design**: Least-privilege defaults, wildcard prevention, PSS enforcement
3. **Clean Plugin Pattern**: Delegation to schema methods, entry point registration
4. **Proper OTel Integration**: Tracing spans for observability
5. **Pydantic v2 Compliance**: Correct modern syntax throughout
6. **Safe YAML Handling**: No unsafe deserialization
7. **Documentation**: Comprehensive docstrings with examples

---

## Conclusion

Epic 7B demonstrates strong architectural alignment with the floe target state. The implementation follows plugin patterns, maintains proper technology ownership, and demonstrates security-conscious design. The one medium finding (missing ABC inheritance) should be addressed before merge but does not block functionality.

**Recommendation:** Address MED-001, then proceed with PR creation via `/speckit.pr`.
