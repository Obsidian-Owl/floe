# Architectural Review Report

**Branch**: 001-manifest-schema â†’ main
**Timestamp**: 2026-01-09 12:00:00 UTC
**Reviewer**: Claude Code (Architectural Review Command)
**Status**: ADVISORY (non-blocking)

## Executive Summary

The 001-manifest-schema feature implements the PlatformManifest schema (Layer 2: Configuration) with excellent alignment to documented architecture. The implementation correctly positions floe-core as the schema/validation layer, supports both 2-tier and 3-tier configuration modes, and properly enforces security policy immutability in inheritance chains.

The codebase demonstrates strong adherence to Pydantic v2 patterns, comprehensive testing with requirement traceability (295 markers across 170 tests), and proper separation of concerns. However, there is one **Medium severity** finding related to plugin category naming that should be addressed for full documentation alignment.

Overall, this is a well-architected implementation that establishes a solid foundation for the manifest schema subsystem.

### Architectural Alignment Score

| Dimension | Score | Assessment |
|-----------|-------|------------|
| Layer Boundaries | 100% | Correctly positions schemas in Layer 1 (Foundation) |
| Technology Ownership | 100% | floe-core owns schema validation, no SQL parsing |
| Contract Compliance | 95% | Excellent Pydantic v2 patterns; minor export gap |
| Security Posture | 100% | No hardcoded secrets, proper SecretReference patterns |
| Testing Standards | 100% | No skipped tests, no hardcoded sleeps, full requirement traceability |
| Standalone-First | 100% | No SaaS dependencies, pure Python implementation |

**Overall Alignment**: 99% (Excellent)

---

## Findings by Severity

### CRITICAL (0)

No critical architectural violations detected.

---

### HIGH (0)

No high severity violations detected.

---

### MEDIUM (1)

#### [MED-001] Plugin Category Naming Mismatch with ADR-0035

**Location**: `packages/floe-core/src/floe_core/schemas/plugins.py:28-36`
**Category**: Documentation Alignment
**Source**: `docs/architecture/adr/0035-observability-plugin-interface.md`, `docs/architecture/plugin-system/index.md`

**Issue**:
The `PluginsConfig` model defines an `observability` plugin category, but ADR-0035 specifies that the "Observability" concept was split into two independent plugins:
- `telemetry_backend` (TelemetryBackendPlugin) - OTLP backends
- `lineage_backend` (LineageBackendPlugin) - OpenLineage backends

The data-model.md and plugins.py both reference a single `observability` category, which contradicts the ADR decision.

**Code Snippet**:
```python
# plugins.py
PLUGIN_REGISTRY: dict[str, list[str]] = {
    ...
    "observability": ["jaeger", "datadog", "grafana-cloud"],  # Should be split
    ...
}

# PluginsConfig
observability: PluginSelection | None = Field(
    default=None,
    description="Observability (jaeger, datadog, grafana-cloud)",
)
```

**ADR-0035 Decision**:
```yaml
# Correct per ADR-0035:
plugins:
  telemetry_backend: jaeger        # Discovered via floe.telemetry_backends
  lineage_backend: marquez          # Discovered via floe.lineage_backends
```

**Why This Matters**:
- ADR-0035 explicitly rejects a unified `ObservabilityPlugin` because OTLP and OpenLineage have different transport mechanisms
- Organizations want mixed backends (e.g., Datadog for telemetry + Atlan for lineage)
- The split architecture allows independent evolution of telemetry vs lineage backends

**Recommendation**:
For 001-manifest-schema scope, this is acceptable since the feature focuses on manifest schema structure. The plugin category split should be addressed in a follow-up task. Options:

1. **Option A (Recommended for now)**: Add a note in spec.md acknowledging the planned split per ADR-0035
2. **Option B (Follow-up epic)**: Split `observability` into `telemetry_backend` and `lineage_backend` categories

**Persona Impact**:
- Data Engineers: Neutral (both patterns work)
- Platform Engineers: Minor confusion potential if docs reference different category names
- DevOps/SREs: Neutral
- Security: Neutral

---

### LOW (2)

#### [LOW-001] Consider Adding SecretStr for Future Password Fields

**Location**: `packages/floe-core/src/floe_core/schemas/secrets.py`
**Category**: Security Enhancement
**Source**: `.claude/rules/security.md`, `.claude/rules/pydantic-contracts.md`

**Issue**:
The `SecretReference` model correctly uses a reference pattern (name + source) rather than storing actual secrets. However, the codebase does not import or use Pydantic's `SecretStr` type anywhere, which would be valuable for any future fields that might temporarily hold credentials during runtime resolution.

**Why This Matters**:
While the current design is secure (secrets are never stored in manifests), future extensions that handle runtime credential resolution would benefit from `SecretStr` to prevent accidental logging of secret values.

**Recommendation**:
Document in the module that `SecretStr` should be used when implementing runtime credential resolution in future components. This is informational for future development.

**Persona Impact**: All neutral (no current code affected)

---

#### [LOW-002] Consider Exporting FORBIDDEN_ENVIRONMENT_FIELDS

**Location**: `packages/floe-core/src/floe_core/schemas/__init__.py`
**Category**: API Completeness
**Source**: `packages/floe-core/src/floe_core/schemas/manifest.py:32`

**Issue**:
The `FORBIDDEN_ENVIRONMENT_FIELDS` constant is defined in `manifest.py` and used for environment-agnostic validation, but it's not exported from the `schemas` module's `__all__`. Users who want to understand or extend the forbidden field list cannot import it directly.

**Why This Matters**:
Minor API completeness issue. The constant documents the environment-agnostic design principle (FR-011) and could be useful for documentation or tooling.

**Recommendation**:
Consider adding to `__all__` in `schemas/__init__.py`:
```python
from floe_core.schemas.manifest import (
    GovernanceConfig,
    ManifestScope,
    PlatformManifest,
    FORBIDDEN_ENVIRONMENT_FIELDS,  # Add this
)
```

**Persona Impact**: All neutral

---

### INFO (3)

#### [INFO-001] Excellent Pydantic v2 Syntax Usage

**Pattern**: All models use correct Pydantic v2 patterns

**Details**:
- `@field_validator` with `@classmethod` (correct)
- `@model_validator(mode="after")` (correct)
- `model_config = ConfigDict(...)` (correct)
- `json_schema_extra` (correct v2 syntax)
- No deprecated `@validator` or `class Config` patterns

This is a positive finding demonstrating excellent adherence to Pydantic v2 standards.

---

#### [INFO-002] Comprehensive Test Coverage with Requirement Traceability

**Pattern**: All 170 tests have `@pytest.mark.requirement()` markers

**Details**:
- 295 requirement markers across 12 test files
- Coverage of FR-001 through FR-018
- No skipped tests (`pytest.skip` / `@pytest.mark.skip`)
- No hardcoded `time.sleep()` in tests
- Contract tests properly located in `tests/contract/`

This is a positive finding demonstrating excellent testing practices.

---

#### [INFO-003] JSON Schema Export Properly Uses Aliases

**Pattern**: JSON Schema correctly uses `apiVersion` (Kubernetes convention)

**Details**:
The implementation correctly uses:
```python
api_version: Literal["floe.dev/v1"] = Field(
    alias="apiVersion",
    description="API version (must be 'floe.dev/v1')",
)
```

And enables:
```python
model_config = ConfigDict(
    ...
    populate_by_name=True,  # Accept both alias and field name
)
```

This aligns with Kubernetes manifest conventions (`apiVersion`, `kind`) while maintaining Pythonic internal naming (`api_version`).

---

## Persona Impact Analysis

### Data Engineers (Primary Persona)

**Summary**: Positive impact

**Positive Impacts** (3):
- Clear, validated schema reduces configuration errors
- IDE autocomplete via JSON Schema export (FR-009)
- Environment-agnostic design (FLOE_ENV resolution) simplifies promotion

**Neutral** (0): None

**Negative Impacts** (0): None

**Net Assessment**:
Data engineers benefit from a well-documented, IDE-friendly schema that catches errors at validation time rather than runtime. The clear error messages guide compliance.

---

### Platform Engineers

**Summary**: Positive impact

**Positive Impacts** (3):
- 2-tier and 3-tier mode support enables growth from simple to Data Mesh
- Security policy immutability enforced in inheritance chains
- Plugin whitelist validation (approved_plugins) enables governance

**Neutral** (1):
- [MED-001]: Plugin category naming (minor confusion potential)

**Negative Impacts** (0): None

**Net Assessment**:
Platform engineers gain strong governance capabilities through security policy immutability and plugin whitelisting. The schema properly supports enterprise hierarchy patterns.

---

### DevOps Engineers / SREs

**Summary**: Positive impact

**Positive Impacts** (2):
- K8s Secret name validation (253 char limit, pattern validation)
- Environment-agnostic artifacts enable immutable deployment promotion

**Neutral** (1):
- Schema validation happens in Python; no K8s-specific validation yet

**Negative Impacts** (0): None

**Net Assessment**:
The schema properly validates K8s-compatible secret names and supports the "compile once, deploy everywhere" pattern critical for CI/CD pipelines.

---

### Security Engineers

**Summary**: Positive impact

**Positive Impacts** (4):
- No hardcoded secrets in codebase
- SecretReference pattern (name + source) prevents secret exposure
- Security policy cannot be weakened in child manifests (FR-017)
- No dangerous constructs (eval, exec, shell=True)

**Neutral** (0): None

**Negative Impacts** (0): None

**Net Assessment**:
Excellent security posture. The SecretReference pattern ensures credentials are never stored in manifests, and the security policy validation prevents governance weakening.

---

## Recommendations (Prioritized)

### Medium Priority (Address Soon)

1. **[MED-001]**: Document plugin category split acknowledgment
   - **Action**: Add a note in `specs/001-manifest-schema/spec.md` acknowledging that the `observability` category will be split per ADR-0035 in a future epic
   - **Reference**: `docs/architecture/adr/0035-observability-plugin-interface.md`
   - **Impact**: Prevents documentation confusion

### Low Priority (Consider for Future)

2. **[LOW-001]**: Document SecretStr usage pattern
   - **Action**: Add comment in `secrets.py` noting that `SecretStr` should be used for runtime credential handling
   - **Reference**: `.claude/rules/pydantic-contracts.md`
   - **Impact**: Guides future development

3. **[LOW-002]**: Export FORBIDDEN_ENVIRONMENT_FIELDS
   - **Action**: Add to `schemas/__init__.py` `__all__` list
   - **Reference**: N/A
   - **Impact**: API completeness

---

## Positive Findings

### [POS-001] Excellent Schema Design for Two-Tier/Three-Tier Modes

**Location**: `packages/floe-core/src/floe_core/schemas/manifest.py`
**Pattern**: Unified `PlatformManifest` with scope-based behavior

**Why This is Good**:
The implementation correctly uses a single `PlatformManifest` model with a `scope` field to differentiate modes:
- `scope=None`: 2-tier mode (standalone platform)
- `scope="enterprise"`: 3-tier mode (parent of hierarchy)
- `scope="domain"`: 3-tier mode (child requiring parent_manifest)

This aligns with `docs/architecture/platform-enforcement.md` which describes the unified `Manifest` type with scope-based behavior.

**Recommendation**: This is the correct pattern. Consider documenting it in architecture docs as the canonical approach.

---

### [POS-002] Security Policy Immutability Implementation

**Location**: `packages/floe-core/src/floe_core/schemas/validation.py`
**Pattern**: Strength-based policy comparison

**Why This is Good**:
The implementation defines clear strength orderings:
```python
PII_ENCRYPTION_STRENGTH = {"optional": 1, "required": 2}
AUDIT_LOGGING_STRENGTH = {"disabled": 1, "enabled": 2}
POLICY_LEVEL_STRENGTH = {"off": 1, "warn": 2, "strict": 3}
```

This exactly matches the algorithm documented in `docs/architecture/platform-enforcement.md`:
> "validate_policy_inheritance: Returns True if child policy is valid (same or stricter)"

**Recommendation**: This is the correct implementation of FR-017.

---

### [POS-003] Environment-Agnostic Design with FORBIDDEN_ENVIRONMENT_FIELDS

**Location**: `packages/floe-core/src/floe_core/schemas/manifest.py:32-50`
**Pattern**: Explicit rejection of environment-specific fields

**Why This is Good**:
```python
FORBIDDEN_ENVIRONMENT_FIELDS = frozenset({
    "env_overrides", "environments", "environment", "env",
    "dev", "staging", "prod", "production", "target_env", "floe_env",
})
```

This prevents the anti-pattern documented in `docs/architecture/opinionation-boundaries.md`:
> "DON'T: Allow per-environment compute... causes drift"

The validator explicitly rejects these fields with an actionable error message pointing to documentation.

**Recommendation**: This is the correct implementation of FR-011.

---

## Change Statistics

**Files Changed**: 34 (+7329, -3 lines)

**By Package**:
- floe-core: 23 files (schemas, tests)
- tests/contract: 1 file
- specs/001-manifest-schema: 8 files
- ci/config: 2 files

**By Layer**:
- Layer 1 (Foundation): 23 files (floe-core schemas)
- Layer 2 (Configuration): 0 files (no manifest.yaml changes)
- Layer 3 (Services): 0 files
- Layer 4 (Data): 0 files

**By Type**:
- Python: 22 files
- JSON: 2 files
- YAML: 2 files
- Markdown: 8 files

---

## Remediation Status

**Date**: 2026-01-09
**Linear Task**: FLO-421

| Finding | Severity | Status | Action Taken |
|---------|----------|--------|--------------|
| MED-001 | Medium | **RESOLVED** | Split `observability` into `telemetry_backend` + `lineage_backend` per ADR-0035 |
| LOW-001 | Low | **RESOLVED** | Added SecretStr documentation note to secrets.py |
| LOW-002 | Low | **RESOLVED** | Exported `FORBIDDEN_ENVIRONMENT_FIELDS` from schemas module |

### Files Modified

- `packages/floe-core/src/floe_core/schemas/plugins.py` - Split observability category
- `packages/floe-core/src/floe_core/schemas/inheritance.py` - Updated merge_manifests category list
- `packages/floe-core/src/floe_core/schemas/__init__.py` - Added FORBIDDEN_ENVIRONMENT_FIELDS export
- `packages/floe-core/src/floe_core/schemas/secrets.py` - Added SecretStr documentation
- `packages/floe-core/tests/unit/schemas/test_plugins.py` - Updated to 12 categories
- `tests/contract/test_manifest_schema.py` - Updated to 12 categories
- `specs/001-manifest-schema/spec.md` - Added ADR-0035 architectural reference
- `specs/001-manifest-schema/data-model.md` - Updated plugin categories
- `specs/001-manifest-schema/contracts/manifest.schema.json` - Regenerated schema

### Updated Alignment Score

| Dimension | Score | Assessment |
|-----------|-------|------------|
| Layer Boundaries | 100% | Correctly positions schemas in Layer 1 (Foundation) |
| Technology Ownership | 100% | floe-core owns schema validation, no SQL parsing |
| Contract Compliance | 100% | Full Pydantic v2 patterns; all exports complete |
| Security Posture | 100% | No hardcoded secrets, proper SecretReference patterns |
| Testing Standards | 100% | No skipped tests, no hardcoded sleeps, full requirement traceability |
| Standalone-First | 100% | No SaaS dependencies, pure Python implementation |

**Overall Alignment**: 100% (Excellent)

---

*Generated by `/arch-review` command*
*Report ID*: arch-review-20260109-120000
*Command Version*: 1.0.0
