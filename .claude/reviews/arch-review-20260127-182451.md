# Architecture Review: Epic 8B Artifact Signing

**Branch**: `8b-artifact-signing`
**Base**: `main`
**Date**: 2026-01-27
**Reviewer**: Automated Architecture Review

---

## Executive Summary

**Overall Assessment: APPROVED WITH MINOR FINDINGS** ✅

Epic 8B (Artifact Signing) introduces a well-designed OCI signing and verification system that aligns with floe's target architecture. The implementation demonstrates strong adherence to:
- Four-layer architecture boundaries
- Pydantic v2 contract patterns
- Technology ownership principles
- Security best practices

| Category | Score | Status |
|----------|-------|--------|
| Layer Boundaries | 9/10 | ✅ Pass |
| Contract Compliance | 9.5/10 | ✅ Pass |
| Security Patterns | 8.5/10 | ✅ Pass (minor improvements suggested) |
| Test Quality | 9/10 | ✅ Pass |
| Documentation | 10/10 | ✅ Excellent |

**Blocking Issues**: None
**Recommended Improvements**: 5 (all LOW/MEDIUM priority)

---

## Architectural Alignment Score

```
┌─────────────────────────────────────────────────────────┐
│  ARCHITECTURE ALIGNMENT                          92%    │
├─────────────────────────────────────────────────────────┤
│  ████████████████████████████████████████░░░░░░░░░░░░  │
└─────────────────────────────────────────────────────────┘
```

---

## Change Statistics

| Metric | Count |
|--------|-------|
| Files Changed | 50 |
| Lines Added | ~15,673 |
| Lines Removed | ~824 |
| New Python Files | 17 |
| New Test Files | 12 |
| New Documentation | 8 |
| Commits | 42 |

### Package Breakdown

| Package/Location | Files | Purpose |
|-----------------|-------|---------|
| `floe-core/oci/` | 5 | Signing, verification, attestation |
| `floe-core/cli/artifact/` | 6 | CLI commands |
| `floe-core/schemas/` | 2 | Pydantic contracts |
| `floe-core/tests/` | 12 | Unit + integration tests |
| `specs/8b-artifact-signing/` | 9 | Specification artifacts |
| `docs/architecture/adr/` | 1 | ADR-0041 |

---

## Findings by Severity

### CRITICAL: None ✅

No critical architectural violations found.

### HIGH: None ✅

No high-priority violations found.

### MEDIUM: 3 Findings

#### M-001: YAML Parsing in CLI Layer (pull.py)

**Location**: `packages/floe-core/src/floe_core/cli/artifact/pull.py:174-207`
**Principle Violated**: Layer Boundaries (CLI should orchestrate, not parse)

**Issue**: `_load_verification_policy()` parses `manifest.yaml` directly in CLI:
```python
# Line 175-183: YAML parsing in CLI
with manifest_path.open() as f:
    manifest_data = yaml.safe_load(f)  # Should be in oci/ module
```

**Impact**:
- Duplicates logic from `OCIClient.from_manifest()` (client.py:345-395)
- Creates maintenance burden
- Violates CLI-as-orchestrator principle

**Recommendation**: Move to `OCIClient.load_verification_policy_from_manifest()` method:
```python
# In oci/client.py:
@classmethod
def load_verification_policy_from_manifest(
    cls, manifest_path: Path
) -> VerificationPolicy | None:
    """Load verification policy from manifest.yaml."""
    # Implementation here

# In cli/artifact/pull.py:
verification_policy = OCIClient.load_verification_policy_from_manifest(manifest_path)
```

---

#### M-002: Bare Exception Handler (signing.py)

**Location**: `packages/floe-core/src/floe_core/oci/signing.py:515-516`
**Principle Violated**: Security Standards (proper error handling)

**Issue**: Silently swallows ALL exceptions:
```python
except Exception:
    pass
```

**Impact**:
- Masks file permission errors
- Hides corrupted key files
- Could mask security-relevant failures

**Recommendation**: Use specific exception handling:
```python
except (OSError, IOError) as e:
    logger.warning("Failed to compute key fingerprint: %s", e)
    return ""
```

---

#### M-003: Unsafe Base64 Decoding Without Size Limits

**Locations**:
- `verification.py:322` - `_verify_keyless()`
- `verification.py:459` - `_verify_key_based()`
- `verification.py:876` - `export_verification_bundle()`

**Principle Violated**: Security Standards (input validation)

**Issue**: Base64 decoding without size validation:
```python
bundle_json = base64.b64decode(metadata.bundle).decode("utf-8")
```

**Impact**:
- Oversized bundles could cause memory exhaustion
- No validation of bundle structure before parsing

**Recommendation**: Add size limit validation:
```python
bundle_bytes = base64.b64decode(metadata.bundle)
if len(bundle_bytes) > 10_000_000:  # 10MB limit
    raise ValueError("Bundle exceeds size limit")
```

---

### LOW: 2 Findings

#### L-001: Missing SecretStr for Bundle Field

**Location**: `packages/floe-core/src/floe_core/schemas/signing.py:300`
**Principle Violated**: Pydantic Contracts (SecretStr for sensitive data)

**Issue**: Bundle field uses plain `str`:
```python
bundle: str = Field(description="Base64-encoded Sigstore bundle")
```

**Recommendation**: Use `SecretStr` to prevent accidental logging:
```python
from pydantic import SecretStr
bundle: SecretStr = Field(description="Base64-encoded Sigstore bundle")
```

---

#### L-002: Environment Variable Parsing Without Bounds

**Locations**:
- `signing.py:68` - `OIDC_MAX_RETRIES`
- `signing.py:209` - `timeout_seconds`

**Issue**: Environment variables parsed without validation:
```python
OIDC_MAX_RETRIES = int(os.environ.get("FLOE_OIDC_TOKEN_MAX_RETRIES", "3"))
```

**Recommendation**: Add bounds checking:
```python
def _get_env_int(name: str, default: int, min_val: int, max_val: int) -> int:
    try:
        value = int(os.environ.get(name, str(default)))
        return max(min_val, min(value, max_val))
    except ValueError:
        return default

OIDC_MAX_RETRIES = _get_env_int("FLOE_OIDC_TOKEN_MAX_RETRIES", 3, 1, 10)
```

---

## Positive Findings

### P-001: Excellent Four-Layer Compliance ✅

The implementation correctly places:
- **Layer 1 (Foundation)**: Schemas in `schemas/signing.py`, interfaces in `oci/`
- **Layer 2 (Configuration)**: `SigningConfig`, `VerificationPolicy` as manifest.yaml extensions
- **Layer 3 (Services)**: CLI commands orchestrate but don't implement
- **Layer 4 (Data)**: N/A (signing is platform-level)

Configuration flows downward only. No Layer 4→Layer 2 violations.

### P-002: Excellent Pydantic v2 Compliance ✅

All 11 models in `schemas/signing.py`:
- Use `model_config = ConfigDict(frozen=True, extra="forbid")`
- Use `@field_validator` (not `@validator`)
- Use `@model_validator(mode="after")` (not `@root_validator`)
- All fields have descriptions
- All models are immutable (frozen=True)

### P-003: Strong Technology Ownership ✅

| Principle | Status | Evidence |
|-----------|--------|----------|
| CLI doesn't parse SQL | ✅ | No SQL in `cli/artifact/` |
| CLI doesn't execute dbt | ✅ | No dbt commands |
| Signing logic in OCI module | ✅ | `oci/signing.py` owns signing |
| Schemas own contracts | ✅ | `schemas/signing.py` defines all models |

### P-004: Comprehensive Security Patterns ✅

- ✅ No `eval()`, `exec()`, `pickle.loads()` in OCI code
- ✅ No `shell=True` in subprocess calls
- ✅ All subprocess calls have timeouts (60s)
- ✅ Proper OpenTelemetry span emission
- ✅ Structured logging with structlog
- ✅ File-based locking for concurrent operations
- ✅ OIDC retry with exponential backoff

### P-005: Excellent Documentation ✅

- ADR-0041 with implementation notes
- Comprehensive docstrings on all public functions
- JSON schema examples in Pydantic models
- CLI help text with examples
- Research notes in `specs/8b-artifact-signing/research.md`

### P-006: Strong Test Coverage ✅

- 12 new test files
- Unit tests for signing, verification, attestation
- Integration tests for E2E flows
- Performance benchmarks
- Security validation tests (error messages)
- All tests have `@pytest.mark.requirement()` markers

---

## Persona Impact Analysis

### Data Engineers (Primary Persona)

| Aspect | Impact | Score |
|--------|--------|-------|
| Cognitive Load | LOW - signing is automatic in CI/CD | ✅ 9/10 |
| Developer Experience | POSITIVE - clear CLI with examples | ✅ 9/10 |
| Clarity | HIGH - error messages are actionable | ✅ 10/10 |
| Workflow | MINIMAL CHANGE - `floe artifact pull` now verifies | ✅ 9/10 |

### Platform Engineers

| Aspect | Impact | Score |
|--------|--------|-------|
| Consistency | HIGH - follows existing CLI patterns | ✅ 10/10 |
| Governance | EXCELLENT - verification policies in manifest | ✅ 10/10 |
| Immutability | PRESERVED - signed artifacts can't be tampered | ✅ 10/10 |
| Multi-env | SUPPORTED - environment-specific policies | ✅ 9/10 |

### DevOps Engineers / SREs

| Aspect | Impact | Score |
|--------|--------|-------|
| K8s-native | NEUTRAL - signing is pre-deployment | ⚡ 8/10 |
| Observability | EXCELLENT - OTel spans for all operations | ✅ 10/10 |
| Declarative | YES - policies in YAML | ✅ 9/10 |
| Reliability | HIGH - retry logic, offline bundles | ✅ 9/10 |

### Security Engineers

| Aspect | Impact | Score |
|--------|--------|-------|
| Credentials | SECURE - no hardcoded secrets | ✅ 10/10 |
| Secrets | GOOD - uses SecretReference pattern | ✅ 9/10 |
| Injection | SAFE - no shell=True, no eval | ✅ 10/10 |
| Validation | STRONG - Pydantic validation everywhere | ✅ 9/10 |

---

## Recommendations (Prioritized)

### Immediate (Before Merge)
None required - all findings are improvements, not blockers.

### Short-term (Next Sprint)
1. **M-001**: Move YAML parsing from pull.py to OCIClient
2. **M-002**: Fix bare exception handler in signing.py

### Medium-term (Backlog)
3. **M-003**: Add size limits to base64 decoding
4. **L-001**: Add SecretStr to bundle field
5. **L-002**: Add bounds checking to env var parsing

---

## Conclusion

Epic 8B Artifact Signing is **architecturally sound** and ready for merge. The implementation:

1. ✅ Follows four-layer architecture principles
2. ✅ Uses Pydantic v2 patterns correctly
3. ✅ Respects technology ownership boundaries
4. ✅ Implements proper security patterns
5. ✅ Has comprehensive test coverage
6. ✅ Is well-documented

The 5 findings are minor improvements that can be addressed post-merge without blocking the epic.

**Recommendation**: **APPROVE FOR MERGE** ✅

---

## References

- [ADR-0041: Artifact Signing and Verification](docs/architecture/adr/0041-artifact-signing-verification.md)
- [Four-Layer Architecture](docs/architecture/four-layer-overview.md)
- [Component Ownership Rules](.claude/rules/component-ownership.md)
- [Security Standards](.claude/rules/security.md)
- [Testing Standards](.claude/rules/testing-standards.md)
