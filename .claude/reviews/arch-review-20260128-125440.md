# Architectural Review: Epic 5B — Data Quality Plugin

**Branch**: `5b-dataquality-plugin`
**Base**: `main`
**Date**: 2026-01-28
**Reviewer**: Sisyphus (automated)

---

## Executive Summary

Epic 5B adds compile-time validation, runtime quality checks, quality scoring, and OpenLineage integration via two new plugins (`floe-quality-gx`, `floe-quality-dbt`) and core schema extensions. The implementation is **architecturally sound** with strong adherence to the four-layer model, plugin conventions, and Pydantic v2 standards.

**Alignment Score: 92/100**

| Category | Score | Notes |
|----------|-------|-------|
| Layer boundaries | 10/10 | No cross-layer or cross-plugin violations |
| Plugin conventions | 10/10 | Entry points, ABCs, imports all correct |
| Contract compliance | 9/10 | Version bumped correctly; ResolvedModel docstring truncated |
| Pydantic v2 syntax | 10/10 | 100% v2 (model_validator, ConfigDict, union types) |
| Testing standards | 9/10 | 292 tests, 87% coverage, 100% requirement markers; SQL injection nosec |
| Security | 9/10 | `nosec B608` on f-string SQL; acceptable but could be parameterized |
| Documentation | 8/10 | Quickstart + config guide created; ResolvedModel docstring reduced |

---

## Findings by Severity

### CRITICAL — None

### HIGH — None

### MEDIUM

#### M1: ResolvedModel docstring truncated
**File**: `packages/floe-core/src/floe_core/schemas/compiled_artifacts.py:229-230`
**Issue**: The `ResolvedModel` docstring was replaced from a full Google-style docstring (with Example, SeeAlso sections) to a one-liner: `"""A transform model with resolved compute target and quality configuration."""`
**Impact**: Reduces LSP hover documentation quality for a key contract model.
**Recommendation**: Restore the full docstring with updated content reflecting the new quality fields.

#### M2: SQL query construction uses f-string
**File**: `plugins/floe-quality-gx/src/floe_quality_gx/executor.py:277`
**Code**: `conn.execute(f"SELECT * FROM {table_name}").fetchdf()`
**Issue**: String interpolation for SQL, suppressed with `# nosec B608`. While `table_name` comes from internal config, this pattern is fragile.
**Impact**: Security (Medium). If `table_name` is ever influenced by user input, this becomes a SQL injection vector.
**Recommendation**: Use DuckDB's `conn.sql()` or validate `table_name` against an allowlist pattern (e.g., `^[a-zA-Z_][a-zA-Z0-9_.]*$`).

### LOW

#### L1: `_factory_get_tracer` "possibly unbound" LSP warning
**File**: `plugins/floe-quality-gx/src/floe_quality_gx/plugin.py:43`, `plugins/floe-quality-dbt/src/floe_quality_dbt/plugin.py:40`
**Issue**: `_factory_get_tracer` is imported inside a `try` block, so LSP reports "possibly unbound". The code is correctly guarded by `_HAS_OTEL` at runtime.
**Recommendation**: Accept as-is. This is the standard graceful degradation pattern used elsewhere (e.g., `rbac/generator.py`).

#### L2: `contextlib.nullcontext` import not needed in dbt plugin
**File**: `plugins/floe-quality-dbt/src/floe_quality_dbt/plugin.py:26`
**Issue**: Minor — `nullcontext` imported from `contextlib`. This is fine and used by `_quality_span`.
**Status**: No action needed.

---

## Positive Findings

### P1: Clean layer boundaries
Both quality plugins import exclusively from `floe_core` public API (`floe_core.plugins.quality`, `floe_core.schemas.*`, `floe_core.plugin_metadata`). No cross-plugin imports. No upward dependencies from `floe_core` to plugins.

### P2: Consistent plugin structure
Both plugins follow the exact same structure as existing plugins (`floe-compute-duckdb`, `floe-orchestrator-dagster`):
- Entry points in `pyproject.toml` under `[project.entry-points."floe.quality"]`
- `__init__.py` with clean exports and `__version__`
- `plugin.py` implementing the `QualityPlugin` ABC
- `py.typed` marker for type checking
- Test organization: `tests/unit/` with `conftest.py`

### P3: Contract version correctly bumped
`COMPILED_ARTIFACTS_VERSION` bumped from `0.3.0` → `0.4.0` (MINOR) with proper version history entry. New fields (`quality_config`, `quality_checks`, `quality_tier`) are all optional with defaults — backward compatible.

### P4: 100% Pydantic v2 compliance
All new schemas use `model_validator(mode="after")`, `ConfigDict(frozen=True, extra="forbid")`, union types (`Type | None`), and `Field()` with descriptions. No v1 syntax anywhere.

### P5: Full requirement traceability
All 292 quality tests have `@pytest.mark.requirement()` markers. No skipped tests. No `time.sleep()`. 87% coverage exceeds the 80% minimum.

### P6: Three-layer scoring model is well-designed
The scoring architecture (dimension weights → severity weights → influence capping) is cleanly separated into `packages/floe-core/src/floe_core/scoring/score_calculator.py` with pure functions, no side effects, and comprehensive test coverage.

### P7: OpenTelemetry integration follows established patterns
Both plugins use `_quality_span()` helper with graceful degradation (`try/except ImportError`), matching the pattern from `rbac/generator.py` and `oci/verification.py`.

---

## Persona Impact Analysis

| Persona | Impact | Score |
|---------|--------|-------|
| **Data Engineers** | Quality checks are declarative (YAML config), three-tier model is intuitive, error messages are actionable | 9/10 |
| **Platform Engineers** | Quality gates enforce at compile-time, inheritance model (enterprise→domain→product) provides governance | 9/10 |
| **DevOps/SREs** | OTel spans added for observability, OpenLineage emitter for lineage tracking | 8/10 |
| **Security Engineers** | No hardcoded secrets, `nosec` on internal-only SQL, Pydantic validation on all inputs | 8/10 |

---

## Change Statistics

| Metric | Value |
|--------|-------|
| Files changed | 78 |
| Lines added | ~14,375 |
| Lines removed | ~106 |
| New packages | 2 (floe-quality-gx, floe-quality-dbt) |
| New core modules | 7 (quality_config, quality_score, quality_errors, scoring, quality_gates, quality_validation, quality_compiler) |
| Tests added | 292 |
| Coverage | 87.17% |
| Contract version | 0.3.0 → 0.4.0 (MINOR) |

---

## Recommendations (Prioritized)

1. **[MEDIUM]** Restore full Google-style docstring on `ResolvedModel` with quality field documentation
2. **[MEDIUM]** Consider adding input validation for `table_name` in `executor.py:277` (regex allowlist)
3. **[LOW]** No action needed on LSP "possibly unbound" warnings — standard pattern

---

## Verdict

**APPROVE** — Branch is architecturally aligned with target state. Two MEDIUM findings are non-blocking improvements. Ready for PR.
