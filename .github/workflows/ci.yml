# Continuous Integration Pipeline
# See .github/CI.md for strategy documentation
#
# Security: All actions pinned to full SHA hashes
# To update: gh api repos/OWNER/REPO/git/refs/tags/VERSION --jq '.object.sha'

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION_DEFAULT: "3.10"
  UV_CACHE_DIR: /tmp/.uv-cache

jobs:
  # ============================================================
  # Stage 1: Lint & Type Check (fast gate)
  # ============================================================
  lint-typecheck:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5
        with:
          python-version: ${{ env.PYTHON_VERSION_DEFAULT }}

      - name: Install uv
        uses: astral-sh/setup-uv@e4db8464a088ece1b920f60402e813ea4de65b8f  # v4
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Install dependencies
        run: uv sync --all-extras --dev

      - name: Run ruff linting
        run: uv run ruff check .

      - name: Run ruff formatting check
        run: uv run ruff format --check .

      - name: Run mypy type checking
        run: uv run mypy --strict packages/

  # ============================================================
  # Stage 2: Unit Tests (matrix across Python versions)
  # ============================================================
  unit-tests:
    name: Unit Tests (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: lint-typecheck
    strategy:
      fail-fast: true
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@e4db8464a088ece1b920f60402e813ea4de65b8f  # v4
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Install dependencies
        run: uv sync --all-extras --dev

      - name: Run unit tests with coverage
        run: |
          uv run pytest packages/floe-core/tests/unit/ \
            -v \
            --cov=packages/floe-core/src \
            --cov-report=xml:coverage-${{ matrix.python-version }}.xml \
            --cov-report=term-missing \
            --cov-fail-under=80

      - name: Upload coverage artifact
        if: matrix.python-version == env.PYTHON_VERSION_DEFAULT
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02  # v4
        with:
          name: coverage-report
          path: coverage-${{ matrix.python-version }}.xml
          retention-days: 7

  # ============================================================
  # Stage 2b: Contract Tests (cross-package validation)
  # ============================================================
  contract-tests:
    name: Contract Tests
    runs-on: ubuntu-latest
    needs: lint-typecheck

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5
        with:
          python-version: ${{ env.PYTHON_VERSION_DEFAULT }}

      - name: Install uv
        uses: astral-sh/setup-uv@e4db8464a088ece1b920f60402e813ea4de65b8f  # v4
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Install dependencies
        run: uv sync --all-extras --dev

      - name: Run contract tests
        run: |
          uv run pytest tests/contract/ \
            -v \
            --tb=short

  # ============================================================
  # Stage 3: SonarCloud Analysis
  # ============================================================
  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: unit-tests
    # Only run on main branch and PRs (not forks for security)
    if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4
        with:
          fetch-depth: 0  # Full history for SonarCloud

      - name: Download coverage artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093  # v4
        with:
          name: coverage-report

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@ba3875ecf642b2129de2b589510c81a8b53dbf4e  # master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.python.coverage.reportPaths=coverage-3.10.xml

  # ============================================================
  # Summary Job (for branch protection)
  # ============================================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [lint-typecheck, unit-tests, contract-tests, sonarcloud]
    if: always()
    steps:
      - name: Check all jobs passed
        env:
          LINT_RESULT: ${{ needs.lint-typecheck.result }}
          UNIT_RESULT: ${{ needs.unit-tests.result }}
          CONTRACT_RESULT: ${{ needs.contract-tests.result }}
          SONAR_RESULT: ${{ needs.sonarcloud.result }}
        run: |
          if [[ "$LINT_RESULT" != "success" ]]; then
            echo "lint-typecheck failed" >&2
            exit 1
          fi
          if [[ "$UNIT_RESULT" != "success" ]]; then
            echo "unit-tests failed" >&2
            exit 1
          fi
          if [[ "$CONTRACT_RESULT" != "success" ]]; then
            echo "contract-tests failed" >&2
            exit 1
          fi
          # SonarCloud is optional for forks
          if [[ "$SONAR_RESULT" != "success" && "$SONAR_RESULT" != "skipped" ]]; then
            echo "sonarcloud failed" >&2
            exit 1
          fi
          echo "All CI checks passed!"
