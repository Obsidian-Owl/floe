# Nightly Pipeline - Scheduled integration tests and dependency audit
#
# Runs at 2am UTC daily to catch:
# - Integration test regressions
# - Dependency vulnerabilities
# - Stale dependencies
#
# See .github/CI.md for workflow documentation

name: Nightly

on:
  schedule:
    # Run at 2am UTC daily
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      run_integration:
        description: 'Run integration tests'
        required: false
        default: true
        type: boolean
      run_audit:
        description: 'Run dependency audit'
        required: false
        default: true
        type: boolean

env:
  PYTHON_VERSION_DEFAULT: "3.10"
  UV_CACHE_DIR: /tmp/.uv-cache

permissions:
  contents: read
  issues: write

jobs:
  # ============================================================
  # Integration Tests (K8s-native with Kind)
  # ============================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'schedule' || inputs.run_integration == true }}

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5
        with:
          python-version: ${{ env.PYTHON_VERSION_DEFAULT }}

      - name: Install uv
        uses: astral-sh/setup-uv@e4db8464a088ece1b920f60402e813ea4de65b8f  # v4
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Install dependencies
        run: uv sync --all-extras --dev

      - name: Install Rust toolchain
        uses: dtolnay/rust-action@stable

      - name: Build dbt-fusion from source (pinned commit)
        env:
          # Pinned commit for reproducibility - update deliberately like a dependency
          # To update: git ls-remote https://github.com/dbt-labs/dbt-fusion.git refs/heads/main
          # Last updated: 2026-01-25
          DBT_FUSION_COMMIT: 091f521e4c45c95097e0a9ef65f61bb45aae194e
        run: |
          git clone https://github.com/dbt-labs/dbt-fusion.git /tmp/dbt-fusion
          cd /tmp/dbt-fusion
          git checkout ${DBT_FUSION_COMMIT}
          cargo build --release --package dbt-sa-cli
          sudo cp target/release/dbt-sa-cli /usr/local/bin/
          sudo chmod +x /usr/local/bin/dbt-sa-cli
          dbt-sa-cli --version || echo "dbt-sa-cli installed (version check may fail)"

      - name: Setup Kind cluster and deploy services
        run: CLUSTER_NAME=floe-nightly ./testing/k8s/setup-cluster.sh
        env:
          SKIP_MONITORING: "true"

      - name: Run integration tests
        run: ./testing/ci/test-integration.sh
        env:
          TEST_NAMESPACE: floe-test

      - name: Collect logs on failure
        if: failure()
        run: ./testing/ci/collect-logs.sh floe-test

      - name: Cleanup Kind cluster
        if: always()
        run: kind delete cluster --name floe-nightly || true

  # ============================================================
  # Dependency Audit
  # ============================================================
  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'schedule' || inputs.run_audit == true }}

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5
        with:
          python-version: ${{ env.PYTHON_VERSION_DEFAULT }}

      - name: Install uv
        uses: astral-sh/setup-uv@e4db8464a088ece1b920f60402e813ea4de65b8f  # v4
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Install dependencies
        run: uv sync --all-extras --dev

      - name: Run vulnerability audit
        uses: ./.github/actions/uv-security-audit

      - name: Check for stale dependencies
        run: |
          echo "Checking for outdated dependencies..."
          uv pip list --outdated || true

  # ============================================================
  # Notify on Failure
  # ============================================================
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [integration-tests, dependency-audit]
    if: failure()

    steps:
      - name: Create issue on failure
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7
        env:
          # Safe: using only GitHub-provided env vars, not user input
          GH_RUN_ID: ${{ github.run_id }}
          GH_RUN_NUMBER: ${{ github.run_number }}
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            const runUrl = `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GH_RUN_ID}`;

            // Check if issue already exists for today
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'nightly-failure',
              per_page: 10
            });

            const todayIssue = issues.data.find(i => i.title.includes(date));
            if (todayIssue) {
              // Add comment to existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: todayIssue.number,
                body: `Another failure detected: [Run #${process.env.GH_RUN_NUMBER}](${runUrl})`
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Nightly build failed: ${date}`,
                body: `## Nightly Build Failure\n\n**Date**: ${date}\n**Run**: [#${process.env.GH_RUN_NUMBER}](${runUrl})\n\nPlease investigate the failure and fix any issues.`,
                labels: ['nightly-failure', 'bug']
              });
            }
