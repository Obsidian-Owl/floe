# Nightly Pipeline - Scheduled integration tests and dependency audit
#
# Runs at 2am UTC daily to catch:
# - Integration test regressions
# - Dependency vulnerabilities
# - Stale dependencies
#
# See .github/CI.md for workflow documentation

name: Nightly

on:
  schedule:
    # Run at 2am UTC daily
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      run_integration:
        description: 'Run integration tests'
        required: false
        default: true
        type: boolean
      run_audit:
        description: 'Run dependency audit'
        required: false
        default: true
        type: boolean
      run_cube_build:
        description: 'Build multi-arch Cube Store image'
        required: false
        default: true
        type: boolean

env:
  PYTHON_VERSION_DEFAULT: "3.10"
  UV_CACHE_DIR: /tmp/.uv-cache

jobs:
  # ============================================================
  # Integration Tests (K8s-native with Kind)
  # ============================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'schedule' || inputs.run_integration == true }}
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5
        with:
          python-version: ${{ env.PYTHON_VERSION_DEFAULT }}

      - name: Install uv
        uses: astral-sh/setup-uv@e4db8464a088ece1b920f60402e813ea4de65b8f  # v4
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Install dependencies
        run: uv sync --all-extras --dev

      - name: Install dbt Fusion CLI
        run: |
          # Install official dbt Fusion CLI from dbt Labs
          curl -fsSL https://public.cdn.getdbt.com/fs/install/install.sh | sh -s -- --update
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          ~/.local/bin/dbt --version

      - name: Setup Kind cluster and deploy services
        run: CLUSTER_NAME=floe-nightly ./testing/k8s/setup-cluster.sh
        env:
          SKIP_MONITORING: "true"

      - name: Run integration tests
        run: ./testing/ci/test-integration.sh
        env:
          TEST_NAMESPACE: floe-test

      - name: Collect logs on failure
        if: failure()
        run: ./testing/ci/collect-logs.sh floe-test

      - name: Cleanup Kind cluster
        if: always()
        run: kind delete cluster --name floe-nightly || true

  # ============================================================
  # Dependency Audit
  # ============================================================
  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'schedule' || inputs.run_audit == true }}
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5
        with:
          python-version: ${{ env.PYTHON_VERSION_DEFAULT }}

      - name: Install uv
        uses: astral-sh/setup-uv@e4db8464a088ece1b920f60402e813ea4de65b8f  # v4
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Install dependencies
        run: uv sync --all-extras --dev

      - name: Run vulnerability audit
        uses: ./.github/actions/uv-security-audit

      - name: Check for stale dependencies
        run: |
          echo "Checking for outdated dependencies..."
          uv pip list --outdated || true

  # ============================================================
  # Multi-Arch Cube Store Build
  # ============================================================
  # Upstream cubejs/cubestore is AMD64-only. This job builds a
  # multi-arch image (amd64 + arm64) via QEMU emulation and
  # pushes to GHCR for use in Kind clusters on Apple Silicon.
  build-cube-store:
    name: Build Multi-Arch Cube Store
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'schedule' || inputs.run_cube_build == true }}
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130  # v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f  # v3

      - name: Login to GHCR
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9  # v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push multi-arch Cube Store
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8  # v6
        with:
          context: docker/cube-store
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ghcr.io/obsidian-owl/cube-store:0.36.0,ghcr.io/obsidian-owl/cube-store:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================================
  # Notify on Failure
  # ============================================================
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [integration-tests, dependency-audit, build-cube-store]
    if: failure()
    permissions:
      issues: write

    steps:
      - name: Create issue on failure
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea  # v7
        env:
          # Safe: using only GitHub-provided env vars, not user input
          GH_RUN_ID: ${{ github.run_id }}
          GH_RUN_NUMBER: ${{ github.run_number }}
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            const runUrl = `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GH_RUN_ID}`;

            // Check if issue already exists for today
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'nightly-failure',
              per_page: 10
            });

            const todayIssue = issues.data.find(i => i.title.includes(date));
            if (todayIssue) {
              // Add comment to existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: todayIssue.number,
                body: `Another failure detected: [Run #${process.env.GH_RUN_NUMBER}](${runUrl})`
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Nightly build failed: ${date}`,
                body: `## Nightly Build Failure\n\n**Date**: ${date}\n**Run**: [#${process.env.GH_RUN_NUMBER}](${runUrl})\n\nPlease investigate the failure and fix any issues.`,
                labels: ['nightly-failure', 'bug']
              });
            }
