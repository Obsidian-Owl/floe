{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://floe.dev/schemas/governance.schema.json",
  "title": "GovernanceConfig",
  "description": "Platform governance settings for policy enforcement",
  "type": "object",
  "properties": {
    "pii_encryption": {
      "type": ["string", "null"],
      "enum": ["required", "optional", null],
      "description": "PII encryption policy (required > optional)"
    },
    "audit_logging": {
      "type": ["string", "null"],
      "enum": ["enabled", "disabled", null],
      "description": "Audit logging policy (enabled > disabled)"
    },
    "policy_enforcement_level": {
      "type": ["string", "null"],
      "enum": ["off", "warn", "strict", null],
      "description": "Global enforcement level (strict > warn > off)"
    },
    "data_retention_days": {
      "type": ["integer", "null"],
      "minimum": 1,
      "description": "Data retention period in days (higher is stricter)"
    },
    "naming": {
      "$ref": "#/$defs/NamingConfig",
      "description": "Naming convention configuration"
    },
    "quality_gates": {
      "$ref": "#/$defs/QualityGatesConfig",
      "description": "Quality gate thresholds"
    },
    "custom_rules": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/CustomRule"
      },
      "default": [],
      "description": "Custom validation rules (Epic 3B)"
    },
    "policy_overrides": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/PolicyOverride"
      },
      "default": [],
      "description": "Override rules for legacy/migration support (Epic 3B)"
    },
    "data_contracts": {
      "$ref": "#/$defs/DataContractsConfig",
      "description": "Data contract validation configuration (Epic 3C)"
    },
    "rbac": {
      "$ref": "#/$defs/RBACConfig",
      "description": "RBAC configuration for compile-time access control (Epic 3E)"
    },
    "secret_scanning": {
      "$ref": "#/$defs/SecretScanningConfig",
      "description": "Secret scanning configuration (Epic 3E)"
    },
    "network_policies": {
      "$ref": "#/$defs/NetworkPoliciesConfig",
      "description": "Network policy generation configuration (Epic 3E)"
    }
  },
  "additionalProperties": false,
  "$defs": {
    "NamingConfig": {
      "type": "object",
      "properties": {
        "enforcement": {
          "type": "string",
          "enum": ["off", "warn", "strict"],
          "default": "warn",
          "description": "Enforcement level for naming conventions"
        },
        "pattern": {
          "type": "string",
          "enum": ["medallion", "kimball", "custom"],
          "default": "medallion",
          "description": "Naming pattern type"
        },
        "custom_patterns": {
          "type": ["array", "null"],
          "items": {
            "type": "string",
            "format": "regex"
          },
          "description": "User-defined regex patterns (required if pattern=custom)"
        }
      },
      "additionalProperties": false,
      "if": {
        "properties": {
          "pattern": { "const": "custom" }
        }
      },
      "then": {
        "required": ["custom_patterns"]
      }
    },
    "QualityGatesConfig": {
      "type": "object",
      "properties": {
        "minimum_test_coverage": {
          "type": "integer",
          "minimum": 0,
          "maximum": 100,
          "default": 80,
          "description": "Minimum test coverage percentage (column-level)"
        },
        "require_descriptions": {
          "type": "boolean",
          "default": false,
          "description": "Require model descriptions"
        },
        "require_column_descriptions": {
          "type": "boolean",
          "default": false,
          "description": "Require column descriptions"
        },
        "block_on_failure": {
          "type": "boolean",
          "default": true,
          "description": "Block compilation on quality gate failure"
        },
        "layer_thresholds": {
          "$ref": "#/$defs/LayerThresholds",
          "description": "Per-layer coverage thresholds (overrides minimum_test_coverage)"
        },
        "zero_column_coverage_behavior": {
          "type": "string",
          "enum": ["report_100_percent", "report_na"],
          "default": "report_na",
          "description": "How to handle models with zero columns: 100% coverage or N/A"
        }
      },
      "additionalProperties": false
    },
    "LayerThresholds": {
      "type": "object",
      "properties": {
        "bronze": {
          "type": "integer",
          "minimum": 0,
          "maximum": 100,
          "default": 50,
          "description": "Bronze layer coverage threshold"
        },
        "silver": {
          "type": "integer",
          "minimum": 0,
          "maximum": 100,
          "default": 80,
          "description": "Silver layer coverage threshold"
        },
        "gold": {
          "type": "integer",
          "minimum": 0,
          "maximum": 100,
          "default": 100,
          "description": "Gold layer coverage threshold"
        }
      },
      "additionalProperties": false
    },
    "CustomRule": {
      "oneOf": [
        { "$ref": "#/$defs/RequireTagsForPrefix" },
        { "$ref": "#/$defs/RequireMetaField" },
        { "$ref": "#/$defs/RequireTestsOfType" }
      ],
      "description": "Discriminated union of custom rule types (Epic 3B)"
    },
    "RequireTagsForPrefix": {
      "type": "object",
      "properties": {
        "type": {
          "const": "require_tags_for_prefix",
          "description": "Rule type discriminator"
        },
        "prefix": {
          "type": "string",
          "minLength": 1,
          "description": "Model name prefix to match (e.g., 'gold_')"
        },
        "required_tags": {
          "type": "array",
          "items": { "type": "string" },
          "minItems": 1,
          "description": "Tags that must be present on matching models"
        },
        "applies_to": {
          "type": "string",
          "default": "*",
          "description": "Glob pattern for model selection (default: all models)"
        }
      },
      "required": ["type", "prefix", "required_tags"],
      "additionalProperties": false
    },
    "RequireMetaField": {
      "type": "object",
      "properties": {
        "type": {
          "const": "require_meta_field",
          "description": "Rule type discriminator"
        },
        "field": {
          "type": "string",
          "minLength": 1,
          "description": "Name of the required meta field (e.g., 'owner')"
        },
        "required": {
          "type": "boolean",
          "default": true,
          "description": "Whether field must have non-empty value"
        },
        "applies_to": {
          "type": "string",
          "default": "*",
          "description": "Glob pattern for model selection (default: all models)"
        }
      },
      "required": ["type", "field"],
      "additionalProperties": false
    },
    "RequireTestsOfType": {
      "type": "object",
      "properties": {
        "type": {
          "const": "require_tests_of_type",
          "description": "Rule type discriminator"
        },
        "test_types": {
          "type": "array",
          "items": { "type": "string" },
          "minItems": 1,
          "description": "List of required test types (e.g., ['not_null', 'unique'])"
        },
        "min_columns": {
          "type": "integer",
          "minimum": 1,
          "default": 1,
          "description": "Minimum columns that must have these tests"
        },
        "applies_to": {
          "type": "string",
          "default": "*",
          "description": "Glob pattern for model selection (default: all models)"
        }
      },
      "required": ["type", "test_types"],
      "additionalProperties": false
    },
    "PolicyOverride": {
      "type": "object",
      "properties": {
        "pattern": {
          "type": "string",
          "minLength": 1,
          "description": "Glob pattern matching model names (e.g., 'legacy_*', 'test_*')"
        },
        "action": {
          "type": "string",
          "enum": ["downgrade", "exclude"],
          "description": "Override action: 'downgrade' (error to warning) or 'exclude' (skip validation)"
        },
        "reason": {
          "type": "string",
          "minLength": 1,
          "description": "Audit trail explaining why this override exists"
        },
        "expires": {
          "type": ["string", "null"],
          "format": "date",
          "description": "Expiration date (ISO-8601). Override ignored after this date."
        },
        "policy_types": {
          "type": ["array", "null"],
          "items": {
            "type": "string",
            "enum": ["naming", "coverage", "documentation", "semantic", "custom"]
          },
          "description": "Limit override to specific policy types (default: all policies)"
        }
      },
      "required": ["pattern", "action", "reason"],
      "additionalProperties": false
    },
    "DataContractsConfig": {
      "type": "object",
      "description": "Configuration for data contract validation (Epic 3C)",
      "properties": {
        "enforcement": {
          "type": "string",
          "enum": ["off", "warn", "strict"],
          "default": "warn",
          "description": "Enforcement level for contract validation (strict > warn > off)"
        },
        "auto_generation": {
          "$ref": "#/$defs/AutoGenerationConfig",
          "description": "Auto-generation settings for contracts from output_ports"
        },
        "drift_detection": {
          "$ref": "#/$defs/DriftDetectionConfig",
          "description": "Schema drift detection settings"
        },
        "inheritance_mode": {
          "type": "string",
          "enum": ["merge", "override", "strict"],
          "default": "merge",
          "description": "Contract inheritance mode"
        }
      },
      "additionalProperties": false
    },
    "AutoGenerationConfig": {
      "type": "object",
      "description": "Auto-generation settings for data contracts",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": false,
          "description": "Enable auto-generation of contracts from output_ports"
        },
        "default_version": {
          "type": "string",
          "default": "1.0.0",
          "description": "Default version for generated contracts"
        },
        "default_status": {
          "type": "string",
          "enum": ["draft", "active", "deprecated"],
          "default": "draft",
          "description": "Default status for generated contracts"
        }
      },
      "additionalProperties": false
    },
    "DriftDetectionConfig": {
      "type": "object",
      "description": "Schema drift detection settings",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": false,
          "description": "Enable schema drift detection"
        },
        "fail_on_type_mismatch": {
          "type": "boolean",
          "default": true,
          "description": "Fail validation on type mismatches"
        },
        "fail_on_missing_column": {
          "type": "boolean",
          "default": true,
          "description": "Fail validation on missing columns"
        },
        "warn_on_extra_column": {
          "type": "boolean",
          "default": true,
          "description": "Warn on extra columns in table"
        }
      },
      "additionalProperties": false
    },
    "RBACConfig": {
      "type": "object",
      "description": "RBAC configuration for compile-time access control (Epic 3E)",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": false,
          "description": "Enable RBAC validation"
        },
        "required_role": {
          "type": ["string", "null"],
          "default": null,
          "description": "Required RBAC role for model access"
        },
        "allow_principal_fallback": {
          "type": "boolean",
          "default": true,
          "description": "Allow principal fallback when role not found"
        }
      },
      "additionalProperties": false
    },
    "SecretPattern": {
      "type": "object",
      "description": "Custom secret detection pattern",
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1,
          "description": "Pattern name"
        },
        "pattern": {
          "type": "string",
          "minLength": 1,
          "description": "Regex pattern for detection"
        },
        "severity": {
          "type": "string",
          "enum": ["error", "warning"],
          "default": "error",
          "description": "Severity level"
        }
      },
      "required": ["name", "pattern"],
      "additionalProperties": false
    },
    "SecretScanningConfig": {
      "type": "object",
      "description": "Secret scanning configuration (Epic 3E)",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": false,
          "description": "Enable secret scanning"
        },
        "exclude_patterns": {
          "type": "array",
          "items": { "type": "string" },
          "default": [],
          "description": "File patterns to exclude from scanning"
        },
        "custom_patterns": {
          "type": ["array", "null"],
          "items": { "$ref": "#/$defs/SecretPattern" },
          "default": null,
          "description": "Custom detection patterns"
        },
        "severity": {
          "type": "string",
          "enum": ["error", "warning"],
          "default": "error",
          "description": "Default severity for findings"
        }
      },
      "additionalProperties": false
    },
    "NetworkPoliciesConfig": {
      "type": "object",
      "description": "Network policy generation configuration (Epic 3E)",
      "properties": {
        "enabled": {
          "type": "boolean",
          "default": false,
          "description": "Enable network policy generation"
        },
        "default_deny": {
          "type": "boolean",
          "default": true,
          "description": "Default deny all egress"
        },
        "custom_egress_rules": {
          "type": "array",
          "items": { "type": "object" },
          "default": [],
          "description": "Custom egress rules"
        }
      },
      "additionalProperties": false
    }
  },
  "examples": [
    {
      "policy_enforcement_level": "strict",
      "naming": {
        "enforcement": "strict",
        "pattern": "medallion"
      },
      "quality_gates": {
        "minimum_test_coverage": 80,
        "require_descriptions": true,
        "layer_thresholds": {
          "bronze": 50,
          "silver": 80,
          "gold": 100
        }
      }
    },
    {
      "policy_enforcement_level": "warn",
      "custom_rules": [
        {
          "type": "require_tags_for_prefix",
          "prefix": "gold_",
          "required_tags": ["tested", "documented"]
        },
        {
          "type": "require_meta_field",
          "field": "owner",
          "applies_to": "gold_*"
        }
      ],
      "policy_overrides": [
        {
          "pattern": "legacy_*",
          "action": "downgrade",
          "reason": "Legacy models being migrated - tracked in JIRA-123",
          "expires": "2026-06-01"
        }
      ]
    }
  ]
}
