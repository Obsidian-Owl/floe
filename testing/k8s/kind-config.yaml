# Kind cluster configuration for floe integration testing
# See: https://kind.sigs.k8s.io/docs/user/configuration/
#
# Usage:
#   kind create cluster --config testing/k8s/kind-config.yaml
#   make kind-up
#
# Features:
#   - Metrics server support (for Lens and kubectl top)
#   - extraPortMappings for localhost service access
#   - Control plane metrics exposed for Prometheus
#   - Ingress-ready labels
---
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
# Note: cluster name is passed via --name flag in setup-cluster.sh
# Do NOT hardcode name here - it breaks CLUSTER_NAME env var override

nodes:
  - role: control-plane
    image: kindest/node:v1.29.0
    kubeadmConfigPatches:
      - |
        kind: InitConfiguration
        nodeRegistration:
          kubeletExtraArgs:
            node-labels: "ingress-ready=true"
      - |
        kind: KubeletConfiguration
        # Resource reservations for system stability
        systemReserved:
          cpu: 100m
          memory: 100Mi
        kubeReserved:
          cpu: 50m
          memory: 50Mi
      - |
        kind: ClusterConfiguration
        # Expose control plane metrics for Prometheus scraping
        controllerManager:
          extraArgs:
            bind-address: 0.0.0.0
        scheduler:
          extraArgs:
            bind-address: 0.0.0.0
        etcd:
          local:
            extraArgs:
              listen-metrics-urls: http://0.0.0.0:2381
    extraMounts:
      # Mount for test artifacts
      - hostPath: /tmp/floe-test-artifacts
        containerPath: /artifacts
    # Port mappings for localhost access to services
    extraPortMappings:
      # Polaris API (NodePort 30181 -> localhost 8181)
      - containerPort: 30181
        hostPort: 8181
        protocol: TCP
      # Dagster Webserver (NodePort 30300 -> localhost 3000)
      - containerPort: 30300
        hostPort: 3000
        protocol: TCP
      # MinIO API (NodePort 30900 -> localhost 9000)
      - containerPort: 30900
        hostPort: 9000
        protocol: TCP
      # MinIO Console (NodePort 30901 -> localhost 9001)
      - containerPort: 30901
        hostPort: 9001
        protocol: TCP
      # Grafana (NodePort 30080 -> localhost 3001)
      - containerPort: 30080
        hostPort: 3001
        protocol: TCP
      # Prometheus (NodePort 30090 -> localhost 9090)
      - containerPort: 30090
        hostPort: 9090
        protocol: TCP
      # Jaeger OTLP gRPC (NodePort 30417 -> localhost 4317)
      - containerPort: 30417
        hostPort: 4317
        protocol: TCP
      # Jaeger Query UI (NodePort 30686 -> localhost 16686)
      - containerPort: 30686
        hostPort: 16686
        protocol: TCP
      # OCI Registry Anonymous (NodePort 30500 -> localhost 30500)
      - containerPort: 30500
        hostPort: 30500
        protocol: TCP
      # OCI Registry Auth (NodePort 30501 -> localhost 30501)
      - containerPort: 30501
        hostPort: 30501
        protocol: TCP
      # Keycloak (NodePort 30082 -> localhost 8082)
      - containerPort: 30082
        hostPort: 8082
        protocol: TCP
      # Infisical (NodePort 30083 -> localhost 8083)
      - containerPort: 30083
        hostPort: 8083
        protocol: TCP

networking:
  # Pod network CIDR
  podSubnet: "10.244.0.0/16"
  # Service network CIDR
  serviceSubnet: "10.96.0.0/16"
  # Use iptables for kube-proxy (faster startup than ipvs)
  kubeProxyMode: iptables

# Containerd configuration for faster image pulls
containerdConfigPatches:
  - |-
    [plugins."io.containerd.grpc.v1.cri".registry.mirrors."localhost:5000"]
      endpoint = ["http://kind-registry:5000"]
