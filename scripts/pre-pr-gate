#!/usr/bin/env bash
# Pre-PR Quality Gate
# Blocks PR creation unless quality checks pass
#
# Called by Claude Code hook: PreToolUse on "gh pr create"
# Returns exit code 0 to allow, non-zero to block

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# State file for tracking quality checks
QUALITY_STATE="${PROJECT_ROOT}/.agent/quality-state.json"

log_info() {
    echo -e "${GREEN}[pre-pr-gate]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[pre-pr-gate]${NC} $1" >&2
}

log_error() {
    echo -e "${RED}[pre-pr-gate]${NC} $1" >&2
}

check_quality_state() {
    if [[ ! -f "$QUALITY_STATE" ]]; then
        return 1
    fi

    # Check if state is recent (within last hour)
    local state_time
    state_time=$(stat -f %m "$QUALITY_STATE" 2>/dev/null || stat -c %Y "$QUALITY_STATE" 2>/dev/null)
    local current_time
    current_time=$(date +%s)
    local age=$((current_time - state_time))

    if [[ $age -gt 3600 ]]; then
        log_warn "Quality state is stale (${age}s old). Re-run checks."
        return 1
    fi

    # Check if all required checks passed
    local test_review_passed
    local integration_check_passed
    local critic_passed

    test_review_passed=$(jq -r '.test_review_passed // false' "$QUALITY_STATE")
    integration_check_passed=$(jq -r '.integration_check_passed // false' "$QUALITY_STATE")
    critic_passed=$(jq -r '.critic_passed // false' "$QUALITY_STATE")

    if [[ "$test_review_passed" != "true" ]]; then
        log_error "Test review not passed. Run /speckit.test-review first."
        return 1
    fi

    if [[ "$integration_check_passed" != "true" ]]; then
        log_error "Integration check not passed. Run /speckit.integration-check first."
        return 1
    fi

    if [[ "$critic_passed" != "true" ]]; then
        log_error "Critic review not passed. The critic agent must approve before PR."
        return 1
    fi

    return 0
}

check_tests_pass() {
    log_info "Checking if unit tests pass..."

    # Quick unit test check
    if ! make test-unit-quick 2>/dev/null; then
        log_error "Unit tests failing. Fix before PR."
        return 1
    fi

    return 0
}

check_lint_pass() {
    log_info "Checking lint status..."

    if ! make lint-check 2>/dev/null; then
        log_error "Lint check failed. Run 'make lint' to fix."
        return 1
    fi

    return 0
}

check_type_check_pass() {
    log_info "Checking type annotations..."

    if ! make typecheck 2>/dev/null; then
        log_error "Type check failed. Fix type errors before PR."
        return 1
    fi

    return 0
}

check_no_uncommitted_changes() {
    log_info "Checking for uncommitted changes..."

    if [[ -n $(git status --porcelain) ]]; then
        log_error "Uncommitted changes detected. Commit or stash before PR."
        git status --short >&2
        return 1
    fi

    return 0
}

check_branch_up_to_date() {
    log_info "Checking if branch is up to date with main..."

    # Fetch latest
    git fetch origin main --quiet 2>/dev/null || true

    # Check if we're behind main
    local behind
    behind=$(git rev-list --count HEAD..origin/main 2>/dev/null || echo "0")

    if [[ "$behind" -gt 0 ]]; then
        log_warn "Branch is ${behind} commits behind main. Consider rebasing."
        # Warning only, not blocking
    fi

    return 0
}

main() {
    log_info "Running pre-PR quality gate..."

    local failed=0

    # Essential checks (always run)
    check_no_uncommitted_changes || failed=1

    # Quality state check (if state file exists)
    if [[ -f "$QUALITY_STATE" ]]; then
        check_quality_state || failed=1
    else
        log_warn "No quality state file found."
        log_warn "For full quality gate, run:"
        log_warn "  1. /speckit.test-review"
        log_warn "  2. /speckit.integration-check"
        log_warn "  3. Critic agent approval"
        log_warn ""
        log_warn "Proceeding with basic checks only..."
    fi

    # Branch check (warning only)
    check_branch_up_to_date || true

    if [[ $failed -ne 0 ]]; then
        log_error ""
        log_error "========================================="
        log_error "PRE-PR QUALITY GATE FAILED"
        log_error "========================================="
        log_error ""
        log_error "Required actions:"
        log_error "  1. Run /speckit.test-review"
        log_error "  2. Run /speckit.integration-check"
        log_error "  3. Get critic agent approval"
        log_error "  4. Commit all changes"
        log_error ""
        exit 1
    fi

    log_info ""
    log_info "========================================="
    log_info "PRE-PR QUALITY GATE PASSED"
    log_info "========================================="
    log_info ""

    exit 0
}

main "$@"
