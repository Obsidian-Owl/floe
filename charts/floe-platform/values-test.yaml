# floe-platform Test Values
# =========================
#
# Minimal configuration for CI/CD testing in Kind clusters.
# Uses single replicas, in-memory storage where possible,
# and reduced resources for faster startup.
#
# Usage:
#   helm install floe-platform ./charts/floe-platform \
#     -f ./charts/floe-platform/values-test.yaml \
#     --namespace floe-test --create-namespace
#
# Requirements:
#   - FR-090: Test-specific configuration
#   - FR-091: Minimal resource usage
#   - SC-011: CI/CD compatibility

# =============================================================================
# Global Test Configuration
# =============================================================================
global:
  environment: test
  imagePullPolicy: IfNotPresent
  imagePullSecrets: []
  storageClass: ""

# =============================================================================
# Namespace Configuration
# =============================================================================
namespace:
  create: true
  name: floe-test

# =============================================================================
# Dagster Configuration (Minimal)
# =============================================================================
dagster:
  enabled: true
  # Disable Dagster's internal PostgreSQL subchart â€” use parent chart's PostgreSQL
  # to avoid duplicate StatefulSet name conflict
  postgresql:
    enabled: false
    postgresqlHost: floe-platform-postgresql
    postgresqlUsername: floe
    postgresqlPassword: "floe-test-password-1234"
    postgresqlDatabase: dagster
  dagsterWebserver:
    replicaCount: 1
    workspace:
      enabled: true
      servers: []  # Must be empty when using externalConfigmap
      externalConfigmap: "floe-platform-dagster-workspace"
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
  dagsterDaemon:
    replicaCount: 1
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
  # Enable user deployments to allow workspace.yaml to be mounted
  # Even with no actual code locations, this enables the workspace file mount
  dagster-user-deployments:
    enabled: true
    enableSubchart: false
    deployments: []

# =============================================================================
# Polaris Configuration (Quarkus 1.3.0 for Tests)
# =============================================================================
polaris:
  enabled: true
  replicaCount: 1
  image:
    repository: apache/polaris
    tag: "1.3.0-incubating"
    pullPolicy: IfNotPresent
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  auth:
    bootstrapCredentials:
      clientId: "test-admin"
      clientSecret: "test-secret"
  config:
    features:
      SKIP_CREDENTIAL_SUBSCOPING_INDIRECTION: "true"
      ALLOW_SETTING_S3_ENDPOINTS: "true"
      ALLOW_TABLE_LOCATION_OVERLAP: "false"
  storage:
    s3:
      enabled: true
      endpoint: "http://floe-platform-minio:9000"
      region: "us-east-1"
      pathStyleAccess: true
      accessKey: "minioadmin"
      secretKey: "minioadmin123"
  bootstrap:
    enabled: true
    catalogName: "floe-e2e"
    defaultBaseLocation: "s3://floe-iceberg"
    allowedLocations:
      - "s3://floe-iceberg"
  service:
    type: ClusterIP
    port: 8181
  # Adjusted probes for test environment (slower startup)
  livenessProbe:
    httpGet:
      path: /q/health/live
      port: management
    initialDelaySeconds: 45
    periodSeconds: 10
    failureThreshold: 6
  readinessProbe:
    httpGet:
      path: /q/health/ready
      port: management
    initialDelaySeconds: 20
    periodSeconds: 5
    failureThreshold: 12

# =============================================================================
# PostgreSQL Configuration (Test Database)
# =============================================================================
postgresql:
  enabled: true
  auth:
    username: floe
    password: "floe-test-password-1234"
    database: floe
  primary:
    persistence:
      enabled: false
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi

# =============================================================================
# MinIO Configuration (Object Storage)
# =============================================================================
minio:
  enabled: true
  mode: standalone
  replicas: 1
  persistence:
    enabled: false
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  auth:
    rootUser: minioadmin
    rootPassword: minioadmin123
  buckets:
    - name: floe-iceberg
      policy: none
  service:
    type: ClusterIP

# =============================================================================
# OpenTelemetry Collector (Disabled for Basic Tests)
# =============================================================================
otel:
  enabled: true
  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi

# =============================================================================
# Observability Components (Disabled for Speed)
# =============================================================================
marquez:
  enabled: false

jaeger:
  enabled: false

prometheus:
  enabled: false

grafana:
  enabled: false

# =============================================================================
# Security Configuration (Relaxed for Tests)
# =============================================================================
podSecurityStandards:
  enabled: false

networkPolicy:
  enabled: false

resourceQuota:
  enabled: false

# =============================================================================
# Autoscaling (Disabled for Tests)
# =============================================================================
autoscaling:
  enabled: false

# =============================================================================
# Pod Disruption Budgets (Disabled for Tests)
# =============================================================================
podDisruptionBudget:
  enabled: false

# =============================================================================
# Test-Specific Overrides
# =============================================================================
test:
  # Enable test mode features
  enabled: true
  # Reduce startup delays
  readinessProbe:
    initialDelaySeconds: 5
    periodSeconds: 3
  livenessProbe:
    initialDelaySeconds: 10
    periodSeconds: 5
  # Skip optional init containers
  skipInitContainers: true
