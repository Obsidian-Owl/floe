# floe-platform Test Values
# =========================
#
# Minimal configuration for CI/CD testing in Kind clusters.
# Uses single replicas, in-memory storage where possible,
# and reduced resources for faster startup.
#
# Usage:
#   helm install floe-platform ./charts/floe-platform \
#     -f ./charts/floe-platform/values-test.yaml \
#     --namespace floe-test --create-namespace
#
# Requirements:
#   - FR-090: Test-specific configuration
#   - FR-091: Minimal resource usage
#   - SC-011: CI/CD compatibility

# =============================================================================
# Global Test Configuration
# =============================================================================
global:
  environment: test
  imagePullPolicy: IfNotPresent
  imagePullSecrets: []
  storageClass: ""

# =============================================================================
# Namespace Configuration
# =============================================================================
namespace:
  create: true
  name: floe-test

# Override fullname to decouple service names from Helm release name
fullnameOverride: floe-platform

# =============================================================================
# Dagster Configuration (Minimal)
# =============================================================================
dagster:
  enabled: true
  # Disable Dagster's internal PostgreSQL subchart — use parent chart's PostgreSQL
  # to avoid duplicate StatefulSet name conflict
  postgresql:
    enabled: false
    postgresqlHost: floe-platform-postgresql
    postgresqlUsername: floe
    postgresqlPassword: "floe-test-password-1234"
    postgresqlDatabase: dagster
  # Demo code locations for E2E tests
  # These use Python module loading pattern - no separate container images needed
  # Tests verify these products appear in Dagster UI
  codeLocations:
    - name: customer-360
      pythonModule:
        moduleName: customer_360.definitions
        workingDirectory: /app/demo
        attribute: defs
    - name: iot-telemetry
      pythonModule:
        moduleName: iot_telemetry.definitions
        workingDirectory: /app/demo
        attribute: defs
    - name: financial-risk
      pythonModule:
        moduleName: financial_risk.definitions
        workingDirectory: /app/demo
        attribute: defs
  dagsterWebserver:
    replicaCount: 1
    image:
      repository: floe-dagster-demo
      tag: latest
      pullPolicy: Never
    workspace:
      enabled: true
      servers: []  # Must be empty when using externalConfigmap
      externalConfigmap: "floe-platform-dagster-workspace"
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
  dagsterDaemon:
    replicaCount: 1
    image:
      repository: floe-dagster-demo
      tag: latest
      pullPolicy: Never
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
  # Enable user deployments to allow workspace.yaml to be mounted
  # Even with no actual code locations, this enables the workspace file mount
  dagster-user-deployments:
    enabled: true
    enableSubchart: false
    deployments: []

# =============================================================================
# Polaris Configuration (Pinned to 1.2.1 — compatible with PyIceberg 0.11.x)
# =============================================================================
polaris:
  enabled: true
  replicaCount: 1
  image:
    repository: apache/polaris
    tag: "1.2.1-incubating"
    pullPolicy: IfNotPresent
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  auth:
    # Demo credentials for local testing only - production MUST use existingSecret
    bootstrapCredentials:
      clientId: "demo-admin"  # pragma: allowlist secret
      clientSecret: "demo-secret"  # pragma: allowlist secret
  config:
    features:
      SKIP_CREDENTIAL_SUBSCOPING_INDIRECTION: "true"
      ALLOW_SETTING_S3_ENDPOINTS: "true"
      ALLOW_TABLE_LOCATION_OVERLAP: "false"
  storage:
    s3:
      enabled: true
      endpoint: "http://floe-platform-minio:9000"
      region: "us-east-1"
      pathStyleAccess: true
      accessKey: "minioadmin"
      secretKey: "minioadmin123"
  bootstrap:
    enabled: true
    catalogName: "floe-e2e"
    defaultBaseLocation: "s3://floe-iceberg"
    allowedLocations:
      - "s3://floe-iceberg"
  service:
    type: ClusterIP
    port: 8181
  # Adjusted probes for test environment (slower startup)
  livenessProbe:
    httpGet:
      path: /q/health/live
      port: management
    initialDelaySeconds: 45
    periodSeconds: 10
    failureThreshold: 6
  readinessProbe:
    httpGet:
      path: /q/health/ready
      port: management
    initialDelaySeconds: 20
    periodSeconds: 5
    failureThreshold: 12

# =============================================================================
# PostgreSQL Configuration (Test Database)
# =============================================================================
postgresql:
  enabled: true
  auth:
    username: floe
    password: "floe-test-password-1234"
    database: floe
  primary:
    persistence:
      enabled: false
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi

# =============================================================================
# MinIO Configuration (Object Storage)
# =============================================================================
minio:
  enabled: true
  mode: standalone
  replicas: 1
  persistence:
    enabled: false
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  auth:
    rootUser: minioadmin
    rootPassword: minioadmin123
  buckets:
    - name: floe-iceberg
      policy: none
  service:
    type: ClusterIP

# =============================================================================
# OpenTelemetry Collector (Disabled for Basic Tests)
# =============================================================================
otel:
  enabled: true
  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi

# =============================================================================
# Observability Components (Enabled by Default)
# =============================================================================
marquez:
  enabled: true
  replicaCount: 1
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

jaeger:
  enabled: true
  provisionDataStore:
    cassandra: false
  allInOne:
    enabled: true
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
  collector:
    enabled: false
  query:
    enabled: false
  agent:
    enabled: false
  cassandra:
    persistence:
      enabled: false
  storage:
    type: memory

prometheus:
  enabled: false

grafana:
  enabled: false

# =============================================================================
# Security Configuration (Relaxed for Tests)
# =============================================================================
podSecurityStandards:
  enabled: false

networkPolicy:
  enabled: false

resourceQuota:
  enabled: false

# =============================================================================
# Autoscaling (Disabled for Tests)
# =============================================================================
autoscaling:
  enabled: false

# =============================================================================
# Pod Disruption Budgets (Disabled for Tests)
# =============================================================================
podDisruptionBudget:
  enabled: false

# =============================================================================
# Test-Specific Overrides
# =============================================================================
test:
  # Enable test mode features
  enabled: true
  # Reduce startup delays
  readinessProbe:
    initialDelaySeconds: 5
    periodSeconds: 3
  livenessProbe:
    initialDelaySeconds: 10
    periodSeconds: 5
  # Skip optional init containers
  skipInitContainers: true

# =============================================================================
# Cube Configuration (Semantic Layer - Test)
# =============================================================================
cube:
  enabled: true
  secret:
    apiSecret: "test-cube-api-secret-32chars000"  # pragma: allowlist secret
  api:
    resources:
      requests:
        cpu: 50m
        memory: 128Mi
      limits:
        cpu: 250m
        memory: 512Mi
  cubeStore:
    enabled: true
    image:
      repository: ghcr.io/obsidian-owl/cube-store
      tag: "v0.36.0"
      pullPolicy: Never
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 1Gi
    persistence:
      enabled: false  # No persistent storage needed in CI
