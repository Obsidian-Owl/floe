{{- if .Values.dagster.enabled }}
{{- if not .Values.dagster.generatePostgresqlPasswordSecret }}
{{/*
Secret for Dagster PostgreSQL connection.
This secret is used by Dagster webserver, daemon, and run pods to connect to PostgreSQL.

When postgresql.enabled is true in the parent chart, the password comes from
postgresql.auth.password (or auto-generated) or postgresql.auth.existingSecret.

For production, use an external secret management solution and set
dagster.postgresqlSecretName to reference it.

When postgresql.enabled is false AND no external credentials provided,
skip creating this secret (user must provide dagster.postgresqlSecretName).
*/}}
{{- $password := "" }}
{{- $host := "" }}
{{- $username := "" }}
{{- $database := "dagster" }}
{{- $shouldRender := true }}
{{- if .Values.postgresql.enabled }}
  {{- $password = .Values.postgresql.auth.password | default (randAlphaNum 24) }}
  {{- $host = printf "%s-postgresql" (include "floe-platform.fullname" .) }}
  {{- $username = .Values.postgresql.auth.username | default "floe" }}
{{- else if and .Values.dagster.postgresqlHost .Values.dagster.postgresqlPassword }}
  {{- $password = .Values.dagster.postgresqlPassword }}
  {{- $host = .Values.dagster.postgresqlHost }}
  {{- $username = .Values.dagster.postgresqlUsername | default "floe" }}
  {{- $database = .Values.dagster.postgresqlDatabase | default "dagster" }}
{{- else }}
  {{/* External PostgreSQL without credentials - skip rendering, user must provide secret */}}
  {{- $shouldRender = false }}
{{- end }}
{{- if $shouldRender }}
{{- $port := .Values.dagster.postgresqlPort | default 5432 }}
{{- $connectionUrl := printf "postgresql://%s:%s@%s:%v/%s" $username $password $host $port $database }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.dagster.postgresqlSecretName | default "dagster-postgresql-secret" }}
  labels:
    {{- include "floe-platform.labels" . | nindent 4 }}
    app.kubernetes.io/component: dagster
  {{- if and .Values.postgresql.enabled (not .Values.postgresql.auth.password) }}
  annotations:
    # Password synced from auto-generated PostgreSQL secret
    helm.sh/resource-policy: keep
  {{- end }}
type: Opaque
{{- if not .Values.postgresql.auth.existingSecret }}
data:
  # Password and connection URL (all base64 encoded for security)
  postgresql-password: {{ $password | b64enc | quote }}
  postgresql-connection: {{ $connectionUrl | b64enc | quote }}
{{- end }}
{{- end }}
{{- end }}
{{- end }}
