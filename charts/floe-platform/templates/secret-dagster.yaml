{{- if .Values.dagster.enabled }}
{{- if not .Values.dagster.generatePostgresqlPasswordSecret }}
{{/*
Secret for Dagster PostgreSQL connection.
This secret is used by Dagster webserver, daemon, and run pods to connect to PostgreSQL.

When postgresql.enabled is true in the parent chart, the password comes from
postgresql.auth.password or postgresql.auth.existingSecret.

For production, use an external secret management solution and set
dagster.postgresqlSecretName to reference it.
*/}}
apiVersion: v1
kind: Secret
metadata:
  name: {{ .Values.dagster.postgresqlSecretName | default "dagster-postgresql-secret" }}
  labels:
    {{- include "floe-platform.labels" . | nindent 4 }}
    app.kubernetes.io/component: dagster
type: Opaque
data:
  {{- if .Values.postgresql.enabled }}
  {{- if .Values.postgresql.auth.existingSecret }}
  {{/* When using existing secret, don't duplicate - reference it in values */}}
  {{- else }}
  postgresql-password: {{ .Values.postgresql.auth.password | default "floe" | b64enc | quote }}
  {{- end }}
  {{- else }}
  {{/* External PostgreSQL - password should be provided via values or external secret */}}
  postgresql-password: {{ .Values.dagster.postgresqlPassword | default "" | b64enc | quote }}
  {{- end }}
stringData:
  {{- if .Values.postgresql.enabled }}
  # Connection string for Dagster to connect to parent chart's PostgreSQL
  postgresql-connection: "postgresql://{{ .Values.postgresql.auth.username | default "floe" }}:{{ .Values.postgresql.auth.password | default "floe" }}@{{ include "floe-platform.fullname" . }}-postgresql:{{ .Values.postgresql.primary.service.ports.postgresql | default 5432 }}/dagster"
  {{- else }}
  # External PostgreSQL connection
  postgresql-connection: "postgresql://{{ .Values.dagster.postgresqlUsername | default "floe" }}:{{ .Values.dagster.postgresqlPassword | default "" }}@{{ .Values.dagster.postgresqlHost }}:{{ .Values.dagster.postgresqlPort | default 5432 }}/{{ .Values.dagster.postgresqlDatabase | default "dagster" }}"
  {{- end }}
{{- end }}
{{- end }}
