{{- if .Values.postgresql.enabled }}
{{- if not .Values.postgresql.auth.existingSecret }}
{{/*
SECURITY: Auto-generate secure password if not provided.
Use postgresql.auth.existingSecret for External Secrets Operator integration.
For production, prefer existingSecret with external secret management.
*/}}
{{- $password := .Values.postgresql.auth.password | default (randAlphaNum 24) }}
{{- if and .Values.postgresql.auth.password (lt (len .Values.postgresql.auth.password) 16) }}
  {{- fail (printf "SECURITY: postgresql.auth.password must be at least 16 characters (got %d)" (len .Values.postgresql.auth.password)) }}
{{- end }}
{{- $postgresPassword := .Values.postgresql.auth.postgresPassword | default $password }}
{{- $username := .Values.postgresql.auth.username | default "floe" }}
{{- $database := .Values.postgresql.auth.database | default "floe" }}
{{- $host := printf "%s-postgresql" (include "floe-platform.fullname" .) }}
{{- $connectionUrl := printf "postgresql://%s:%s@%s:5432/%s" $username $password $host $database }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "floe-platform.fullname" . }}-postgresql
  labels:
    {{- include "floe-platform.labels" . | nindent 4 }}
    app.kubernetes.io/component: postgresql
  {{- if not .Values.postgresql.auth.password }}
  annotations:
    # Password auto-generated by Helm. Use postgresql.auth.existingSecret for production.
    helm.sh/resource-policy: keep
  {{- end }}
type: Opaque
data:
  postgresql-password: {{ $password | b64enc | quote }}
  postgresql-postgres-password: {{ $postgresPassword | b64enc | quote }}
  # Connection URL (base64 encoded, not plaintext)
  postgresql-url: {{ $connectionUrl | b64enc | quote }}
{{- end }}
{{- end }}
