{{/*
ExternalSecret for floe-platform.

Creates ExternalSecret resources to sync secrets from external providers
(AWS Secrets Manager, HashiCorp Vault, Azure Key Vault, etc.)

Requires External Secrets Operator to be installed in the cluster.

Requirements:
- 9b-FR-040: External Secrets template
*/}}
{{- if .Values.externalSecrets.enabled }}
{{- range .Values.externalSecrets.secrets }}
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "floe-platform.fullname" $ }}-{{ .name }}
  namespace: {{ $.Release.Namespace }}
  labels:
    {{- include "floe-platform.labels" $ | nindent 4 }}
spec:
  refreshInterval: {{ $.Values.externalSecrets.refreshInterval | default "1h" }}
  secretStoreRef:
    {{- if .secretStoreRef }}
    name: {{ .secretStoreRef.name }}
    kind: {{ .secretStoreRef.kind | default "ClusterSecretStore" }}
    {{- else }}
    name: {{ $.Values.externalSecrets.secretStoreRef.name }}
    kind: {{ $.Values.externalSecrets.secretStoreRef.kind | default "ClusterSecretStore" }}
    {{- end }}
  target:
    name: {{ .targetSecretName | default .name }}
    {{- if .template }}
    template:
      {{- toYaml .template | nindent 6 }}
    {{- end }}
    {{- if .creationPolicy }}
    creationPolicy: {{ .creationPolicy }}
    {{- end }}
    {{- if .deletionPolicy }}
    deletionPolicy: {{ .deletionPolicy }}
    {{- end }}
  {{- if .data }}
  data:
    {{- range .data }}
    - secretKey: {{ .secretKey }}
      remoteRef:
        key: {{ .remoteRef.key }}
        {{- if .remoteRef.property }}
        property: {{ .remoteRef.property }}
        {{- end }}
        {{- if .remoteRef.version }}
        version: {{ .remoteRef.version }}
        {{- end }}
    {{- end }}
  {{- end }}
  {{- if .dataFrom }}
  dataFrom:
    {{- range .dataFrom }}
    - extract:
        key: {{ .extract.key }}
        {{- if .extract.version }}
        version: {{ .extract.version }}
        {{- end }}
        {{- if .extract.property }}
        property: {{ .extract.property }}
        {{- end }}
    {{- end }}
  {{- end }}
{{- end }}

{{- /* Pre-configured secrets for common floe components */ -}}
{{- if .Values.externalSecrets.postgresql.enabled }}
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "floe-platform.fullname" . }}-postgresql
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "floe-platform.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.externalSecrets.refreshInterval | default "1h" }}
  secretStoreRef:
    name: {{ .Values.externalSecrets.secretStoreRef.name }}
    kind: {{ .Values.externalSecrets.secretStoreRef.kind | default "ClusterSecretStore" }}
  target:
    name: {{ .Values.postgresql.auth.existingSecret | default (printf "%s-postgresql" (include "floe-platform.fullname" .)) }}
  data:
    - secretKey: password
      remoteRef:
        key: {{ .Values.externalSecrets.postgresql.remoteRef.key }}
        property: {{ .Values.externalSecrets.postgresql.remoteRef.property | default "password" }}
{{- end }}

{{- if .Values.externalSecrets.minio.enabled }}
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "floe-platform.fullname" . }}-minio
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "floe-platform.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.externalSecrets.refreshInterval | default "1h" }}
  secretStoreRef:
    name: {{ .Values.externalSecrets.secretStoreRef.name }}
    kind: {{ .Values.externalSecrets.secretStoreRef.kind | default "ClusterSecretStore" }}
  target:
    name: {{ .Values.minio.auth.existingSecret | default (printf "%s-minio" (include "floe-platform.fullname" .)) }}
  data:
    - secretKey: root-user
      remoteRef:
        key: {{ .Values.externalSecrets.minio.remoteRef.key }}
        property: {{ .Values.externalSecrets.minio.remoteRef.userProperty | default "username" }}
    - secretKey: root-password
      remoteRef:
        key: {{ .Values.externalSecrets.minio.remoteRef.key }}
        property: {{ .Values.externalSecrets.minio.remoteRef.passwordProperty | default "password" }}
{{- end }}
{{- end }}
