{{/*
Helm test pod for floe-jobs chart.
Run with: helm test <release-name>

Tests performed:
1. dbt job configuration validation
2. Platform connectivity (if platform reference configured)
3. Basic job execution check

Requirements:
- 9b-FR-084: Helm test pod
*/}}
apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "floe-jobs.fullname" . }}-test-job"
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "floe-jobs.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  restartPolicy: Never
  containers:
    # Test dbt configuration
    {{- if .Values.dbt.enabled }}
    - name: test-dbt-config
      image: {{ .Values.dbt.image.repository | default "ghcr.io/dbt-labs/dbt-core" }}:{{ .Values.dbt.image.tag | default "latest" }}
      command:
        - /bin/sh
        - -c
        - |
          echo "Testing dbt configuration..."
          
          # Verify dbt is installed
          if ! dbt --version > /dev/null 2>&1; then
            echo "FAILED: dbt is not available"
            exit 1
          fi
          echo "SUCCESS: dbt is installed"
          
          # Check profiles configuration
          if [ -n "$DBT_PROFILES_DIR" ]; then
            if [ -f "$DBT_PROFILES_DIR/profiles.yml" ]; then
              echo "SUCCESS: dbt profiles.yml found"
            else
              echo "WARNING: DBT_PROFILES_DIR set but profiles.yml not found"
            fi
          fi
          
          echo "SUCCESS: dbt configuration test passed"
          exit 0
      env:
        - name: DBT_PROFILES_DIR
          value: /etc/dbt
      resources:
        limits:
          cpu: 100m
          memory: 256Mi
        requests:
          cpu: 50m
          memory: 128Mi
    {{- end }}

    # Test platform connectivity
    {{- if .Values.platform.release }}
    - name: test-platform-connectivity
      image: curlimages/curl:8.5.0
      command:
        - /bin/sh
        - -c
        - |
          echo "Testing platform connectivity..."
          
          {{- if .Values.platform.namespace }}
          DAGSTER_URL="http://{{ .Values.platform.release }}-dagster-webserver.{{ .Values.platform.namespace }}.svc.cluster.local:80"
          {{- else }}
          DAGSTER_URL="http://{{ .Values.platform.release }}-dagster-webserver:80"
          {{- end }}
          
          for i in 1 2 3 4 5; do
            if curl -sf "${DAGSTER_URL}/server_info" > /dev/null 2>&1; then
              echo "SUCCESS: Platform Dagster is reachable"
              exit 0
            fi
            echo "Attempt $i: Platform not ready, waiting..."
            sleep 5
          done
          
          echo "WARNING: Platform Dagster not reachable (may be expected if platform is separate)"
          exit 0
      resources:
        limits:
          cpu: 100m
          memory: 64Mi
        requests:
          cpu: 50m
          memory: 32Mi
    {{- end }}

    # Test custom jobs configuration
    {{- if .Values.customJobs }}
    - name: test-custom-jobs
      image: busybox:1.36
      command:
        - /bin/sh
        - -c
        - |
          echo "Testing custom jobs configuration..."

          # Count configured jobs
          JOB_COUNT={{ len .Values.customJobs }}
          echo "Found ${JOB_COUNT} custom job(s) configured"

          {{- range .Values.customJobs }}
          echo "  - {{ .name }}: {{ .image.repository | default "unknown" }}"
          {{- end }}

          echo "SUCCESS: Custom jobs configuration validated"
          exit 0
      resources:
        limits:
          cpu: 50m
          memory: 32Mi
        requests:
          cpu: 25m
          memory: 16Mi
    {{- end }}

    # Fallback test if nothing else is enabled
    {{- if and (not .Values.dbt.enabled) (not .Values.platform.release) (not .Values.customJobs) }}
    - name: test-basic
      image: busybox:1.36
      command:
        - /bin/sh
        - -c
        - |
          echo "Basic floe-jobs chart test"
          echo "No dbt, platform, or custom jobs configured"
          echo "SUCCESS: Chart deployed successfully"
          exit 0
      resources:
        limits:
          cpu: 50m
          memory: 32Mi
        requests:
          cpu: 25m
          memory: 16Mi
    {{- end }}
